<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√∫ Principal - Distribuci√≥n Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: auto; }
        
        header { background: #2c3e50; color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.4rem; }
        .info-empresa { font-size: 0.9rem; margin-top: 5px; opacity: 0.8; }

        /* DASHBOARD */
        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            text-align: left;
            border-top: 5px solid #34495e;
        }
        .dash-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .dash-title { font-size: 1.1rem; color: #2c3e50; font-weight: bold; margin: 0; }
        
        /* CAJA DESTACADA */
        .highlight-box {
            background: #e8f8f5; border: 1px solid #a2d9ce; color: #148f77;
            padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px;
        }
        .highlight-box.urgent { background: #fadbd8; border-color: #e6b0aa; color: #c0392b; }

        /* LISTAS */
        .scroll-list {
            max-height: 300px; overflow-y: auto;
            border: 1px solid #eee; border-radius: 8px; padding: 5px;
            background: #fafafa; margin-bottom: 20px;
        }

        .item-list {
            padding: 12px; border-bottom: 1px solid #eee; font-size: 0.95rem;
            display: flex; justify-content: space-between; align-items: center;
            background: white; cursor: pointer; transition: 0.2s;
        }
        .item-list:hover { background-color: #f0f8ff; } 
        .item-list:last-child { border-bottom: none; }
        
        /* SEM√ÅFORO */
        .dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 10px; flex-shrink: 0; }
        .dot-red { background-color: #c0392b; }
        .dot-yellow { background-color: #f1c40f; }
        .dot-green { background-color: #27ae60; }
        .dot-gray { background-color: #95a5a6; } 

        /* MODAL (VENTANA EMERGENTE) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; text-align: left; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; font-weight: bold; cursor: pointer; color: #aaa; }
        .table-detalle { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .table-detalle th { background: #eee; text-align: left; padding: 8px; }
        .table-detalle td { border-bottom: 1px solid #eee; padding: 8px; }
        .badge-in { color: #27ae60; font-weight: bold; background: #e8f8f5; padding: 2px 6px; border-radius: 4px; }
        .badge-out { color: #c0392b; font-weight: bold; background: #fadbd8; padding: 2px 6px; border-radius: 4px; }

        /* GRID MEN√ö */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-menu { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; font-size: 1rem; font-weight: bold; color: white; text-decoration: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: 80px; }
        .btn-ventas { background: #e67e22; grid-column: span 2; }
        .btn-compras { background: #2980b9; }
        .btn-cartera { background: #27ae60; }
        .btn-tesoreria { background: #c0392b; }
        .btn-clientes { background: #8e44ad; }
        .btn-productos { background: #16a085; }
        .btn-salir { background: #7f8c8d; margin-top: 30px; width: 100%; padding: 12px; border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Distribuci√≥n Pro üß¨</h1>
        <div class="info-empresa" id="headerInfo">Cargando datos...</div>
    </header>

    <div class="dashboard-card">
        <div class="dash-header">
            <h3 class="dash-title">üìä Inventario Real</h3>
            <small id="totalItems">Cargando...</small>
        </div>
        <div id="boxProximo" class="highlight-box" style="display:none;">Cargando...</div>
        
        <div class="scroll-list" id="listaVencimientos">
            <p style="text-align:center; padding:20px; color:#aaa;">Calculando stock...</p>
        </div>

        <div class="dash-header" style="margin-top:20px; border-top:2px dashed #eee; padding-top:15px;">
            <h3 class="dash-title">üöö Despachos Pendientes</h3>
            <small id="totalEntregas">0</small>
        </div>
        <div class="scroll-list" id="listaEntregas">
            <p style="text-align:center; padding:20px; color:#aaa;">Buscando pedidos...</p>
        </div>
    </div>

    <div class="menu-grid">
        <a href="ventas.html" class="btn-menu btn-ventas">üöö Registrar Venta</a>
        <a href="compras.html" class="btn-menu btn-compras">üì¶ Compras</a>
        <a href="productos.html" id="btnProductos" class="btn-menu btn-productos">üçé Productos</a>
        <a href="cartera.html" class="btn-menu btn-cartera">üí∞ Cartera</a>
        <a href="tesoreria.html" class="btn-menu btn-tesoreria">üí∏ Pagos</a>
        <a href="clientes.html" class="btn-menu btn-clientes" style="grid-column: span 2;">üë• Clientes</a>
    </div>

    <button id="btnLogout" class="btn-salir">Cerrar Sesi√≥n</button>
</div>

<div id="modalDetalle" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('modalDetalle').style.display='none'">&times;</span>
        <h3 id="modalTitle" style="color:#2c3e50; border-bottom:2px solid #e67e22; padding-bottom:10px;">Detalle</h3>
        
        <h4 style="margin: 15px 0 5px 0; color:#27ae60;">üì• Entradas (Compras)</h4>
        <div style="max-height:150px; overflow-y:auto; border:1px solid #eee; border-radius:6px;">
            <table class="table-detalle">
                <tbody id="tablaEntradas"></tbody>
            </table>
        </div>

        <h4 style="margin: 20px 0 5px 0; color:#c0392b;">üì§ Salidas (Ventas)</h4>
        <div style="max-height:150px; overflow-y:auto; border:1px solid #eee; border-radius:6px;">
            <table class="table-detalle">
                <tbody id="tablaSalidas"></tbody>
            </table>
        </div>
        
        <div style="text-align:right; margin-top:15px; font-weight:bold;">
            Stock Final: <span id="modalStock" style="color:#2980b9; font-size:1.2rem;">0</span>
        </div>
    </div>
</div>

<script type="module">
    import { auth, db, ref, onValue, update, get, child } from './firebase.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const nit = localStorage.getItem('userNit');
    const rol = localStorage.getItem('userRole');
    
    // VARIABLE GLOBAL PARA GUARDAR DETALLES
    let inventarioDetallado = {}; 

    onAuthStateChanged(auth, (user) => {
        if (!user || !nit) {
            window.location.href = "index.html";
        } else {
            document.getElementById('headerInfo').innerText = `NIT: ${nit}`;
            if (rol === 'vendedor') document.getElementById('btnProductos').classList.add('hidden');
            
            cargarDashboardInventario();
            cargarEntregasPendientes();
        }
    });

    // 1. CARGAR INVENTARIO CON HISTORIAL DETALLADO (L√ìGICA CORREGIDA)
    function cargarDashboardInventario() {
        const boxProximo = document.getElementById('boxProximo');
        const listaDiv = document.getElementById('listaVencimientos');
        
        onValue(ref(db, `companies/${nit}/inventario`), async (snapInventario) => {
            const snapVentas = await get(child(ref(db), `companies/${nit}/ventas`));
            
            listaDiv.innerHTML = "";
            inventarioDetallado = {}; // Reiniciar variable global
            
            // MAPA DE IDs: Clave = ID de Firebase, Valor = Clave de Agrupaci√≥n (Prod|Lote|Vence)
            const idToKeyMap = {}; 

            if (!snapInventario.exists()) {
                listaDiv.innerHTML = "<p style='text-align:center;'>Vac√≠o</p>";
                document.getElementById('totalItems').innerText = "0 Refs";
                return;
            }

            // --- FASE 1: AGRUPAR ENTRADAS Y MAPEAR IDs ---
            snapInventario.forEach(child => {
                const item = child.val();
                const firebaseID = child.key; // ID √∫nico del lote en Firebase

                const prodName = (item.producto || "").trim();
                const lote = (item.lote || "S/L").trim();
                let vence = (item.vence || "N/A").trim();
                if(vence === "" || vence === "S/F") vence = "N/A";

                // Llave √∫nica de agrupaci√≥n
                const uniqueKey = `${prodName}|${lote}|${vence}`;

                // --- CORRECCI√ìN: Guardamos la relaci√≥n ID -> Llave √önica ---
                idToKeyMap[firebaseID] = uniqueKey;

                if (!inventarioDetallado[uniqueKey]) {
                    inventarioDetallado[uniqueKey] = {
                        producto: prodName,
                        lote: lote,
                        vence: vence,
                        cantidad: 0,
                        listaEntradas: [],
                        listaSalidas: []
                    };
                }

                // Sumar cantidad y registrar movimiento de compra
                const fechaCompra = item.fecha_ingreso ? new Date(item.fecha_ingreso).toLocaleDateString() : "S/F";
                inventarioDetallado[uniqueKey].cantidad += parseInt(item.cantidad || 0);
                inventarioDetallado[uniqueKey].listaEntradas.push({
                    fecha: fechaCompra,
                    cant: item.cantidad
                });
            });

            // --- FASE 2: RESTAR VENTAS USANDO EL ID (M√ÅS SEGURO) ---
            if (snapVentas.exists()) {
                snapVentas.forEach(childVenta => {
                    const venta = childVenta.val();
                    const fechaVenta = new Date(venta.fecha).toLocaleDateString();

                    if (venta.items && Array.isArray(venta.items)) {
                        venta.items.forEach(itemVendido => {
                            let targetKey = null;

                            // 1. INTENTO POR ID (Lo m√°s preciso)
                            if (itemVendido.idLote && idToKeyMap[itemVendido.idLote]) {
                                targetKey = idToKeyMap[itemVendido.idLote];
                            } 
                            // 2. INTENTO POR NOMBRE (Fallback si no hay ID)
                            else {
                                const prodName = (itemVendido.producto || "").trim();
                                const lote = (itemVendido.lote || "S/L").trim();
                                let vence = (itemVendido.vence || "N/A").trim();
                                targetKey = `${prodName}|${lote}|${vence}`;
                            }

                            // Si encontramos el lote en el inventario, restamos
                            if (targetKey && inventarioDetallado[targetKey]) {
                                // Restar stock
                                inventarioDetallado[targetKey].cantidad -= parseInt(itemVendido.cantidad || 0);
                                
                                // Registrar movimiento salida en la lista
                                inventarioDetallado[targetKey].listaSalidas.push({
                                    fecha: fechaVenta,
                                    cliente: venta.cliente || "Cliente",
                                    cant: itemVendido.cantidad
                                });
                            }
                        });
                    }
                });
            }

            // --- FASE 3: RENDERIZAR ---
            let itemsArray = Object.values(inventarioDetallado).filter(i => i.cantidad > 0);
            
            // Ordenar por vencimiento
            itemsArray.sort((a,b) => {
                if(a.vence === 'N/A') return 1;
                if(b.vence === 'N/A') return -1;
                return new Date(a.vence) - new Date(b.vence);
            });

            document.getElementById('totalItems').innerText = itemsArray.length + " Refs";

            // L√≥gica caja destacada
            if (itemsArray.length > 0 && itemsArray[0].vence !== 'N/A') {
                const primero = itemsArray[0];
                const diff = Math.ceil((new Date(primero.vence) - new Date()) / (86400000));
                boxProximo.style.display = 'block';
                boxProximo.innerHTML = `‚ö†Ô∏è <strong>${primero.producto}</strong> vence el ${primero.vence} (${diff} d√≠as)`;
            } else {
                boxProximo.style.display = 'none';
            }

            const hoy = new Date();
            const alerta = new Date(); alerta.setDate(hoy.getDate() + 30);

            itemsArray.forEach(item => {
                // Reconstruir la KEY para el onclick
                const keyRaw = `${item.producto}|${item.lote}|${item.vence}`;
                
                let color = "dot-gray";
                let textoVence = "N/A";
                if(item.vence !== 'N/A'){
                    textoVence = item.vence;
                    const d = new Date(item.vence);
                    if(d < hoy) color = "dot-red";
                    else if(d <= alerta) color = "dot-yellow";
                    else color = "dot-green";
                }

                listaDiv.innerHTML += `
                    <div class="item-list" onclick="window.verDetalleProducto('${keyRaw}')">
                        <div style="display:flex; align-items:center; flex: 1;">
                            <span class="dot ${color}"></span>
                            <div>
                                <strong>${item.producto}</strong><br>
                                <small style="color:#777;">Lote: ${item.lote} | Vence: ${textoVence}</small>
                                <br><small style="color:#2980b9; font-size:0.8rem;">Click para ver historial üîç</small>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <span style="font-size:1.2rem; font-weight:bold; color:#2c3e50;">${item.cantidad}</span>
                            <small style="display:block; color:#aaa;">Unid.</small>
                        </div>
                    </div>`;
            });
        });
    }

    // ABRIR MODAL
    window.verDetalleProducto = (key) => {
        const data = inventarioDetallado[key];
        if(!data) return;

        document.getElementById('modalTitle').innerHTML = `${data.producto}<br><small style='font-size:0.8rem; color:#777;'>Lote: ${data.lote}</small>`;
        document.getElementById('modalStock').innerText = data.cantidad;

        // Llenar tabla Entradas
        const tEntradas = document.getElementById('tablaEntradas');
        tEntradas.innerHTML = "";
        if(data.listaEntradas.length === 0) tEntradas.innerHTML = "<tr><td>Sin registros</td></tr>";
        else {
            data.listaEntradas.forEach(e => {
                tEntradas.innerHTML += `<tr>
                    <td>${e.fecha}</td>
                    <td style="text-align:right;"><span class="badge-in">+${e.cant}</span></td>
                </tr>`;
            });
        }

        // Llenar tabla Salidas
        const tSalidas = document.getElementById('tablaSalidas');
        tSalidas.innerHTML = "";
        if(data.listaSalidas.length === 0) tSalidas.innerHTML = "<tr><td colspan='2' style='color:#aaa;'>No se ha vendido nada de este lote.</td></tr>";
        else {
            data.listaSalidas.forEach(s => {
                tSalidas.innerHTML += `<tr>
                    <td>
                        <div style="font-weight:bold;">${s.cliente}</div>
                        <small style="color:#777;">${s.fecha}</small>
                    </td>
                    <td style="text-align:right;"><span class="badge-out">-${s.cant}</span></td>
                </tr>`;
            });
        }

        document.getElementById('modalDetalle').style.display = 'block';
    };

    window.onclick = function(event) {
        const modal = document.getElementById('modalDetalle');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // CARGAR ENTREGAS (Igual que antes)
    function cargarEntregasPendientes() {
        const listaDiv = document.getElementById('listaEntregas');
        onValue(ref(db, `companies/${nit}/ventas`), (snap) => {
            listaDiv.innerHTML = "";
            let pendientes = [];
            if (snap.exists()) {
                snap.forEach(child => {
                    const venta = child.val();
                    venta.idFirebase = child.key;
                    if ((venta.estado_entrega || "PENDIENTE") === "PENDIENTE") pendientes.push(venta);
                });
            }
            document.getElementById('totalEntregas').innerText = pendientes.length;
            if (pendientes.length === 0) { listaDiv.innerHTML = "<div style='text-align:center; padding:15px; color:#27ae60;'>‚úÖ Todo entregado.</div>"; return; }
            
            pendientes.sort((a,b) => a.fecha - b.fecha);
            pendientes.forEach(venta => {
                const fecha = new Date(venta.fecha).toLocaleDateString();
                const descProd = venta.items && venta.items.length > 0 ? (venta.items.length > 1 ? `${venta.items[0].producto} (+${venta.items.length-1})` : venta.items[0].producto) : "Varios";
                listaDiv.innerHTML += `
                    <div class="item-list" style="border-left: 4px solid #e67e22;">
                        <div style="flex:1;"><strong>${venta.cliente}</strong><br><small style="color:#777;">${descProd} (${fecha})</small></div>
                        <div><button class="btn-fast-check" onclick="window.marcarEntregadoDash('${venta.idFirebase}')">‚úÖ</button></div>
                    </div>`;
            });
        });
    }

    window.marcarEntregadoDash = async (idVenta) => {
        if(confirm("¬øConfirmar entrega?")) {
            try { await update(ref(db, `companies/${nit}/ventas/${idVenta}`), { estado_entrega: "ENTREGADO" }); } 
            catch(e) { alert("Error: " + e.message); }
        }
    };

    document.getElementById('btnLogout').onclick = () => {
        signOut(auth).then(() => { localStorage.clear(); window.location.href = "index.html"; });
    };
</script>

</body>
</html>
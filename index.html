<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso - Distribuci贸n Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #2c3e50; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .login-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 100%; max-width: 380px; text-align: center; }
        
        h2 { color: #2c3e50; margin-bottom: 5px; }
        p { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 25px; }
        
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1rem; font-weight: bold; margin-top: 15px; transition: 0.3s; }
        button:hover { background: #2980b9; }
        
        .error-msg { color: #e74c3c; background: #fdf2f2; padding: 10px; border-radius: 4px; display: none; margin-top: 15px; font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="login-card">
    <h2>К Distribuci贸n Pro</h2>
    <p>Inicie sesi贸n para gestionar su empresa</p>

    <input type="text" id="nitInput" placeholder="NIT de la Empresa">
    <input type="email" id="emailInput" placeholder="Correo electr贸nico">
    <input type="password" id="passInput" placeholder="Contrase帽a">

    <button id="btnLogin">ENTRAR AL SISTEMA</button>
    <div id="errorMsg" class="error-msg"></div>
</div>

<script type="module">
    // Importamos las herramientas desde tu archivo central
    import { auth, db, ref, get } from './firebase.js';
    import { signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const btnLogin = document.getElementById('btnLogin');
    const errorDiv = document.getElementById('errorMsg');

    // Funci贸n principal de Login
    btnLogin.onclick = async () => {
        const nit = document.getElementById('nitInput').value;
        const email = document.getElementById('emailInput').value;
        const pass = document.getElementById('passInput').value;

        if (!nit || !email || !pass) {
            mostrarError("Por favor, llene todos los campos.");
            return;
        }

        try {
            // 1. Autenticar con Firebase Auth
            const userCred = await signInWithEmailAndPassword(auth, email, pass);
            const uid = userCred.user.uid;

            // 2. Verificar perfil en Realtime Database (Tenant check)
            const snapshot = await get(ref(db, `users/${uid}`));
            
            if (snapshot.exists()) {
                const userData = snapshot.val();

                // 3. Validar que el NIT coincida con el usuario
                if (userData.nit === nit) {
                    // Guardar datos en el navegador para uso de las otras p谩ginas
                    localStorage.setItem('userNit', userData.nit);
                    localStorage.setItem('userRole', userData.role);
                    
                    window.location.href = "menu.html";
                } else {
                    mostrarError("El NIT no pertenece a esta cuenta.");
                    auth.signOut();
                }
            } else {
                mostrarError("Usuario no configurado en la base de datos.");
                auth.signOut();
            }

        } catch (e) {
            console.error(e);
            mostrarError("Acceso denegado. Verifique sus datos.");
        }
    };

    function mostrarError(msg) {
        errorDiv.innerText = msg;
        errorDiv.style.display = 'block';
    }

    // Si ya tiene una sesi贸n activa, lo mandamos directo al men煤
    onAuthStateChanged(auth, (user) => {
        if (user && localStorage.getItem('userNit')) {
            window.location.href = "menu.html";
        }
    });
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√∫ Principal - Distribuci√≥n Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: auto; }
        
        header { background: #2c3e50; color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.4rem; }
        .info-empresa { font-size: 0.9rem; margin-top: 5px; opacity: 0.8; }

        /* DASHBOARD */
        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            text-align: left;
            border-top: 5px solid #34495e;
        }
        .dash-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .dash-title { font-size: 1.1rem; color: #2c3e50; font-weight: bold; margin: 0; }
        
        /* CAJA DESTACADA */
        .highlight-box {
            background: #e8f8f5; border: 1px solid #a2d9ce; color: #148f77;
            padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px;
        }
        .highlight-box strong { font-size: 1.1rem; display: block; margin-bottom: 5px; }
        .highlight-box.urgent { background: #fadbd8; border-color: #e6b0aa; color: #c0392b; }

        /* LISTAS */
        .scroll-list {
            max-height: 300px; overflow-y: auto;
            border: 1px solid #eee; border-radius: 8px; padding: 5px;
            background: #fafafa; margin-bottom: 20px;
        }

        .item-list {
            padding: 12px; border-bottom: 1px solid #eee; font-size: 0.95rem;
            display: flex; justify-content: space-between; align-items: center;
            background: white;
        }
        .item-list:last-child { border-bottom: none; }
        
        /* SEM√ÅFORO */
        .dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 10px; flex-shrink: 0; }
        .dot-red { background-color: #c0392b; box-shadow: 0 0 5px #c0392b; }
        .dot-yellow { background-color: #f1c40f; box-shadow: 0 0 5px #f1c40f; }
        .dot-green { background-color: #27ae60; }
        .dot-gray { background-color: #95a5a6; } 
        
        /* BOT√ìN ENTREGAR */
        .btn-fast-check {
            background: #27ae60; color: white; border: none; padding: 6px 12px;
            border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;
        }

        /* GRID MEN√ö */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 400px) { .menu-grid { grid-template-columns: 1fr; } }

        .btn-menu { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 20px; font-size: 1rem; font-weight: bold; color: white; 
            text-decoration: none; border-radius: 10px; transition: 0.3s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: 80px;
        }
        .btn-ventas { background: #e67e22; grid-column: span 2; }
        .btn-compras { background: #2980b9; }
        .btn-cartera { background: #27ae60; }
        .btn-tesoreria { background: #c0392b; }
        .btn-clientes { background: #8e44ad; }
        .btn-productos { background: #16a085; }
        .btn-salir { background: #7f8c8d; margin-top: 30px; width: 100%; padding: 12px; border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Distribuci√≥n Pro üß¨</h1>
        <div class="info-empresa" id="headerInfo">Cargando datos...</div>
    </header>

    <div class="dashboard-card">
        
        <div class="dash-header">
            <h3 class="dash-title">üìä Inventario y Vencimientos</h3>
            <small id="totalItems">Cargando...</small>
        </div>
        <div id="boxProximo" class="highlight-box" style="display:none;">Cargando...</div>
        
        <div class="scroll-list" id="listaVencimientos">
            <p style="text-align:center; padding:20px; color:#aaa;">Leyendo base de datos...</p>
        </div>

        <div class="dash-header" style="margin-top:20px; border-top:2px dashed #eee; padding-top:15px;">
            <h3 class="dash-title">üöö Despachos Pendientes</h3>
            <small id="totalEntregas">0</small>
        </div>
        <div class="scroll-list" id="listaEntregas">
            <p style="text-align:center; padding:20px; color:#aaa;">Buscando pedidos...</p>
        </div>

    </div>

    <div class="menu-grid">
        <a href="ventas.html" class="btn-menu btn-ventas">üöö Registrar Venta</a>
        <a href="compras.html" id="btnCompras" class="btn-menu btn-compras">üì¶ Compras</a>
        <a href="productos.html" id="btnProductos" class="btn-menu btn-productos">üçé Productos</a>
        <a href="cartera.html" class="btn-menu btn-cartera">üí∞ Cartera (Ingresos)</a>
        <a href="tesoreria.html" class="btn-menu btn-tesoreria">üí∏ Pagos (Egresos)</a>
        <a href="clientes.html" class="btn-menu btn-clientes" style="grid-column: span 2;">üë• Directorio de Clientes</a>
    </div>

    <button id="btnLogout" class="btn-salir">Cerrar Sesi√≥n</button>
</div>

<script type="module">
    import { auth, db, ref, onValue, update } from './firebase.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const nit = localStorage.getItem('userNit');
    const rol = localStorage.getItem('userRole');

    onAuthStateChanged(auth, (user) => {
        if (!user || !nit) {
            window.location.href = "index.html";
        } else {
            document.getElementById('headerInfo').innerText = `Empresa NIT: ${nit} | Rol: ${rol}`;
            if (rol === 'vendedor') document.getElementById('btnProductos').classList.add('hidden');
            
            cargarDashboardInventario();
            cargarEntregasPendientes();
        }
    });

    // 1. CARGAR INVENTARIO COMPLETO (AGRUPADO Y ORDENADO)
    function cargarDashboardInventario() {
        const boxProximo = document.getElementById('boxProximo');
        const listaDiv = document.getElementById('listaVencimientos');
        
        onValue(ref(db, `companies/${nit}/inventario`), (snap) => {
            listaDiv.innerHTML = "";
            if (!snap.exists()) {
                listaDiv.innerHTML = "<p style='text-align:center; padding:20px;'>El inventario est√° vac√≠o.</p>";
                boxProximo.style.display = 'none'; 
                document.getElementById('totalItems').innerText = "0 Refs";
                return;
            }

            // --- FASE 1: AGRUPACI√ìN ---
            const groupedMap = {};

            snap.forEach(child => {
                const item = child.val();
                // Normalizamos datos para la clave √∫nica
                const prodName = (item.producto || "").trim();
                const lote = (item.lote || "S/L").trim();
                let vence = (item.vence || "N/A").trim();
                if(vence === "" || vence === "S/F") vence = "N/A";

                // Clave √∫nica: Producto + Lote + Vencimiento
                const uniqueKey = `${prodName}|${lote}|${vence}`;

                if (groupedMap[uniqueKey]) {
                    // Si ya existe, sumamos cantidad
                    groupedMap[uniqueKey].cantidad += parseInt(item.cantidad || 0);
                } else {
                    // Si no, lo creamos
                    groupedMap[uniqueKey] = {
                        producto: prodName,
                        lote: lote,
                        vence: vence,
                        cantidad: parseInt(item.cantidad || 0)
                    };
                }
            });

            // Convertimos el mapa de nuevo a un array
            const itemsAgrupados = Object.values(groupedMap);

            // --- FASE 2: CLASIFICACI√ìN (Con fecha vs Sin fecha) ---
            const conFecha = [];
            const sinFecha = [];

            itemsAgrupados.forEach(item => {
                if (item.vence && item.vence !== 'N/A' && item.vence !== 'S/F') {
                    conFecha.push(item);
                } else {
                    sinFecha.push(item);
                }
            });

            document.getElementById('totalItems').innerText = itemsAgrupados.length + " Refs";

            // Ordenar los que TIENEN fecha (el m√°s pr√≥ximo arriba)
            conFecha.sort((a,b) => new Date(a.vence) - new Date(b.vence));

            // Unirlos: Primero los con fecha, luego los sin fecha
            const itemsFinal = [...conFecha, ...sinFecha];

            // LOGICA CAJA DESTACADA (Solo para el primero de la lista con fecha)
            if (conFecha.length > 0) {
                const primero = conFecha[0];
                const hoy = new Date();
                const fechaVence = new Date(primero.vence);
                
                const diffDays = Math.ceil((fechaVence - hoy) / (1000 * 60 * 60 * 24));
                let texto = diffDays < 0 ? "¬°VENCIDO!" : (diffDays === 0 ? "¬°Vence HOY!" : `Faltan ${diffDays} d√≠as`);
                let clase = (diffDays <= 30) ? "urgent" : "";

                boxProximo.style.display = 'block';
                boxProximo.className = `highlight-box ${clase}`;
                boxProximo.innerHTML = `<small>‚ö†Ô∏è Atenci√≥n Inmediata:</small><strong>${primero.producto}</strong><span>Vence: ${primero.vence} (${texto})</span>`;
            } else {
                boxProximo.style.display = 'none';
            }

            // RENDERIZAR LA LISTA COMPLETA
            const hoy = new Date();
            const limiteAlerta = new Date();
            limiteAlerta.setDate(hoy.getDate() + 30);

            itemsFinal.forEach(item => {
                let color = "dot-gray"; 
                let textoVence = "No vence";
                
                // Si est√° en el grupo "conFecha", calculamos su color
                if (item.vence && item.vence !== 'N/A') {
                    textoVence = item.vence;
                    const d = new Date(item.vence);
                    if (d < hoy) color = "dot-red";
                    else if (d <= limiteAlerta) color = "dot-yellow";
                    else color = "dot-green";
                }

                listaDiv.innerHTML += `
                    <div class="item-list">
                        <div style="display:flex; align-items:center; flex: 1;">
                            <span class="dot ${color}"></span>
                            <div>
                                <strong>${item.producto}</strong><br>
                                <small style="color:#777;">Lote: ${item.lote}</small>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <span style="font-weight:bold; color:${color === 'dot-gray' ? '#aaa' : '#555'};">${textoVence}</span>
                            <br><small style="color:#2980b9; font-weight:bold; font-size:0.95rem;">Cant: ${item.cantidad}</small>
                        </div>
                    </div>`;
            });
        });
    }

    // 2. CARGAR ENTREGAS PENDIENTES
    function cargarEntregasPendientes() {
        const listaDiv = document.getElementById('listaEntregas');
        onValue(ref(db, `companies/${nit}/ventas`), (snap) => {
            listaDiv.innerHTML = "";
            let pendientes = [];
            if (snap.exists()) {
                snap.forEach(child => {
                    const venta = child.val();
                    venta.idFirebase = child.key;
                    if ((venta.estado_entrega || "PENDIENTE") === "PENDIENTE") pendientes.push(venta);
                });
            }
            document.getElementById('totalEntregas').innerText = pendientes.length;
            if (pendientes.length === 0) { listaDiv.innerHTML = "<div style='text-align:center; padding:15px; color:#27ae60;'>‚úÖ Todo entregado.</div>"; return; }
            
            pendientes.sort((a,b) => a.fecha - b.fecha);
            pendientes.forEach(venta => {
                const fecha = new Date(venta.fecha).toLocaleDateString();
                const descProd = venta.items && venta.items.length > 0 ? (venta.items.length > 1 ? `${venta.items[0].producto} (+${venta.items.length-1})` : venta.items[0].producto) : "Varios";
                listaDiv.innerHTML += `
                    <div class="item-list" style="border-left: 4px solid #e67e22;">
                        <div style="flex:1;"><strong>${venta.cliente}</strong><br><small style="color:#777;">${descProd} (${fecha})</small></div>
                        <div><button class="btn-fast-check" onclick="window.marcarEntregadoDash('${venta.idFirebase}')">‚úÖ Entregar</button></div>
                    </div>`;
            });
        });
    }

    window.marcarEntregadoDash = async (idVenta) => {
        if(confirm("¬øConfirmar entrega?")) {
            try { await update(ref(db, `companies/${nit}/ventas/${idVenta}`), { estado_entrega: "ENTREGADO" }); } 
            catch(e) { alert("Error: " + e.message); }
        }
    };

    document.getElementById('btnLogout').onclick = () => {
        signOut(auth).then(() => { localStorage.clear(); window.location.href = "index.html"; });
    };
</script>

</body>
</html>
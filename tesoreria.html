<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TesorerÃ­a y Pagos - DistribuciÃ³n Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 100%; max-width: 950px; }
        
        /* COLOR ROJO/NARANJA PARA DIFERENCIAR DE CARTERA (EGRESOS) */
        h2 { color: #c0392b; border-bottom: 3px solid #e74c3c; padding-bottom: 15px; margin-top: 0; }

        .search-section { position: relative; margin-bottom: 25px; }
        label { font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; transition: 0.3s; background: #fafafa; }
        input:focus { border-color: #e74c3c; outline: none; background: white; }

        .lista-resultados { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .item-resultado { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .item-resultado:hover { background: #fadbd8; color: #c0392b; }

        .switch-container { display: flex; gap: 20px; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .radio-group { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        input[type="radio"] { width: auto; transform: scale(1.2); cursor: pointer; }

        #seccionFacturas, #seccionOtro { display: none; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid #eee; }
        th { background: #fadbd8; text-align: left; padding: 10px; color: #922b21; font-size: 0.9rem; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; vertical-align: middle; }
        .row-selected { background-color: #f5b7b1; border-left: 5px solid #c0392b; }

        .total-box { text-align: right; font-size: 1.3rem; font-weight: bold; margin: 20px 0; color: #c0392b; }
        .btn-save { background: #e74c3c; color: white; width: 100%; padding: 15px; border: none; border-radius: 6px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-save:hover { background: #c0392b; }
        .btn-back { background: #95a5a6; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 20px; }
        .btn-limpiar { background: #f39c12; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; float: right; }

        .historial-section { margin-top: 50px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .badge { padding: 3px 8px; border-radius: 12px; color: white; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-back" onclick="location.href='menu.html'">â¬… Volver</button>
    
    <h2>ðŸ’¸ Comprobantes de Egreso (Pagos)</h2>

    <div class="search-section">
        <label>Buscar Proveedor / Beneficiario <button class="btn-limpiar" onclick="location.reload()">ðŸ”„ Limpiar</button></label>
        <input type="text" id="inputProv" placeholder="Buscar por Nombre, Finca o NIT..." autocomplete="off">
        <div id="listaProv" class="lista-resultados"></div>
    </div>

    <div class="switch-container">
        <label class="radio-group">
            <input type="radio" name="tipoEgreso" value="factura" checked onchange="window.cambiarModo()"> 
            <span>Pago de Factura Proveedor (Cuentas por Pagar)</span>
        </label>
        <label class="radio-group">
            <input type="radio" name="tipoEgreso" value="otro" onchange="window.cambiarModo()"> 
            <span>Gasto General (NÃ³mina, Servicios, Arriendo...)</span>
        </label>
    </div>

    <div id="seccionFacturas">
        <p style="color:#777; font-size:0.9rem;">Seleccione la factura de compra que va a pagar:</p>
        <table>
            <thead>
                <tr>
                    <th>Sel.</th>
                    <th>Fecha Compra</th>
                    <th>Total</th>
                    <th>Abonado</th>
                    <th>Saldo Pendiente</th>
                    <th>Pagar Ahora</th>
                </tr>
            </thead>
            <tbody id="listaFacturas">
                <tr><td colspan="6" style="text-align:center;">Busque un proveedor para ver sus deudas.</td></tr>
            </tbody>
        </table>
    </div>

    <div id="seccionOtro">
        <label>Concepto del Gasto</label>
        <input type="text" id="descOtro" placeholder="Ej: Pago de Luz, NÃ³mina de Juan...">
        
        <label style="margin-top:10px;">Valor a Pagar</label>
        <input type="number" id="valorOtro" placeholder="$ 0">
    </div>

    <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-top:20px;">
        <label>Sale el dinero de:</label>
        <select id="medioPago">
            <option>Caja General (Efectivo)</option>
            <option>Cuenta Bancaria</option>
        </select>
        <label style="margin-top:10px;">Observaciones</label>
        <textarea id="observaciones" rows="2" placeholder="Notas opcionales..."></textarea>
    </div>

    <div class="total-box" id="txtTotalEgreso">Total a Pagar: $0</div>

    <button class="btn-save" id="btnGuardar">ðŸ”´ REGISTRAR EGRESO</button>

    <div class="historial-section">
        <h3 id="tituloHistorial">ðŸ“œ Historial General de Egresos</h3>
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Beneficiario</th>
                    <th>Concepto</th>
                    <th>Valor</th>
                    <th>Tipo</th>
                </tr>
            </thead>
            <tbody id="tablaHistorialEgresos">
                <tr><td colspan="5" style="text-align:center;">Cargando...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script type="module">
    import { db, ref, push, onValue, update } from './firebase.js';

    const nit = localStorage.getItem('userNit');
    if (!nit) window.location.href = "index.html";

    let todosProveedores = [];
    let todosEgresos = [];
    let facturaSeleccionada = null; 

    // 1. CARGAR PROVEEDORES (Son los mismos 'clientes' en tu sistema unificado)
    onValue(ref(db, `companies/${nit}/clientes`), s => {
        todosProveedores = [];
        if(s.exists()) Object.values(s.val()).forEach(c => todosProveedores.push(c));
    });

    // 2. CARGAR HISTORIAL EGRESOS
    onValue(ref(db, `companies/${nit}/egresos`), (snap) => {
        todosEgresos = [];
        if (snap.exists()) {
            Object.values(snap.val()).forEach(r => todosEgresos.push(r));
        }
        actualizarTablaHistorial(); 
    });

    function actualizarTablaHistorial() {
        const tbody = document.getElementById('tablaHistorialEgresos');
        const filtro = document.getElementById('inputProv').value;
        const titulo = document.getElementById('tituloHistorial');
        tbody.innerHTML = "";
        
        let lista = filtro ? todosEgresos.filter(r => r.beneficiario === filtro) : todosEgresos;
        titulo.innerText = filtro ? `ðŸ“œ Egresos a: ${filtro}` : `ðŸ“œ Historial General de Egresos`;

        if (lista.length === 0) { tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No hay egresos registrados.</td></tr>"; return; }

        lista.sort((a,b) => b.fecha - a.fecha);
        lista.slice(0, 30).forEach(r => {
            const fecha = new Date(r.fecha).toLocaleDateString();
            const estilo = r.tipo === 'EGRESO_CXP' ? 'background:#e67e22' : 'background:#c0392b';
            const texto = r.tipo === 'EGRESO_CXP' ? 'Pago Factura' : 'Gasto/Otro';
            tbody.innerHTML += `
                <tr style="animation:fadeIn 0.5s">
                    <td><small>${fecha}</small></td>
                    <td><strong>${r.beneficiario}</strong></td>
                    <td><small>${r.concepto}</small></td>
                    <td style="color:#c0392b; font-weight:bold;">$${parseFloat(r.valor).toLocaleString()}</td>
                    <td><span class="badge" style="${estilo}; color:white;">${texto}</span></td>
                </tr>`;
        });
    }

    // 3. BUSCADOR
    const inpProv = document.getElementById('inputProv');
    const mostrarProv = (txt="") => {
        const div = document.getElementById('listaProv'); div.innerHTML='';
        let res = txt==="" ? todosProveedores.slice(0,10) : todosProveedores.filter(c=>c.nombre.toLowerCase().includes(txt.toLowerCase()));
        if(!res.length){ div.style.display='none'; return;}
        res.forEach(c=>{
            const d=document.createElement('div'); d.className='item-resultado'; d.innerText=c.nombre;
            d.onclick=()=>{
                inpProv.value=c.nombre; div.style.display='none';
                cargarDeudasProveedor(c.nombre); 
                actualizarTablaHistorial();
            }; 
            div.appendChild(d);
        }); 
        div.style.display='block';
    };
    inpProv.addEventListener('input', (e)=>{ mostrarProv(e.target.value); if(e.target.value==="") actualizarTablaHistorial(); });
    inpProv.addEventListener('focus', ()=>mostrarProv(inpProv.value));
    document.addEventListener('click', (e)=>{if(!e.target.matches('input')){document.getElementById('listaProv').style.display='none';}});

    // 4. CARGAR DEUDAS DE COMPRA
    function cargarDeudasProveedor(nombreProv) {
        const tbody = document.getElementById('listaFacturas');
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Buscando facturas pendientes...</td></tr>";

        // LEEMOS 'compras_registros'
        onValue(ref(db, `companies/${nit}/compras_registros`), (snap) => {
            tbody.innerHTML = "";
            let tieneDeudas = false;

            if (snap.exists()) {
                snap.forEach(child => {
                    const compra = child.val();
                    compra.id = child.key;
                    
                    // Mostrar solo si es el proveedor Y hay saldo
                    if (compra.proveedor === nombreProv && compra.saldo > 0) {
                        tieneDeudas = true;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><input type="radio" name="selFactura" value="${compra.id}"></td>
                            <td>${new Date(compra.fecha).toLocaleDateString()}</td>
                            <td>$${compra.total.toLocaleString()}</td>
                            <td style="color:green;">$${(compra.abonado || 0).toLocaleString()}</td>
                            <td style="color:red; font-weight:bold;">$${compra.saldo.toLocaleString()}</td>
                            <td><input type="number" class="input-abono" id="abono_${compra.id}" disabled style="width:100px; padding:8px;"></td>
                        `;
                        
                        tr.querySelector('input[type="radio"]').onclick = () => seleccionarFactura(compra, tr);
                        tr.querySelector('.input-abono').addEventListener('input', (e) => {
                             document.getElementById('txtTotalEgreso').innerText = `Total a Pagar: $${parseFloat(e.target.value || 0).toLocaleString()}`;
                        });
                        tbody.appendChild(tr);
                    }
                });
            }
            if (!tieneDeudas) tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:green; font-weight:bold;'>ðŸŽ‰ No le debes nada a este proveedor.</td></tr>";
        });
    }

    function seleccionarFactura(compra, trDOM) {
        document.querySelectorAll('.input-abono').forEach(i => { i.disabled = true; i.value = ''; });
        document.querySelectorAll('tr').forEach(r => r.classList.remove('row-selected'));
        
        const input = document.getElementById(`abono_${compra.id}`);
        input.disabled = false; input.value = compra.saldo; input.focus();
        
        trDOM.classList.add('row-selected');
        facturaSeleccionada = compra;
        document.getElementById('txtTotalEgreso').innerText = `Total a Pagar: $${compra.saldo.toLocaleString()}`;
    }

    // 5. SWITCH MODO
    window.cambiarModo = () => {
        const modo = document.querySelector('input[name="tipoEgreso"]:checked').value;
        if (modo === 'factura') {
            document.getElementById('seccionFacturas').style.display = 'block';
            document.getElementById('seccionOtro').style.display = 'none';
        } else {
            document.getElementById('seccionFacturas').style.display = 'none';
            document.getElementById('seccionOtro').style.display = 'block';
            document.getElementById('txtTotalEgreso').innerText = "Total a Pagar: $0";
            facturaSeleccionada = null;
        }
    };
    cambiarModo(); 

    document.getElementById('valorOtro').addEventListener('input', (e) => {
        document.getElementById('txtTotalEgreso').innerText = `Total a Pagar: $${parseFloat(e.target.value || 0).toLocaleString()}`;
    });

    // 6. GUARDAR EGRESO
    document.getElementById('btnGuardar').onclick = async () => {
        const prov = document.getElementById('inputProv').value;
        const medio = document.getElementById('medioPago').value;
        const obs = document.getElementById('observaciones').value;
        const modo = document.querySelector('input[name="tipoEgreso"]:checked').value;

        if (modo === 'factura' && !prov) return alert("Seleccione un proveedor");

        try {
            if (modo === 'factura') {
                if (!facturaSeleccionada) return alert("Seleccione una factura");
                const monto = parseFloat(document.getElementById(`abono_${facturaSeleccionada.id}`).value);
                if (!monto || monto <= 0) return alert("Monto invÃ¡lido");
                if (monto > facturaSeleccionada.saldo) return alert("Monto supera el saldo");

                // Guardar Egreso (CXP)
                await push(ref(db, `companies/${nit}/egresos`), {
                    fecha: Date.now(), beneficiario: prov, concepto: "Pago Factura " + new Date(facturaSeleccionada.fecha).toLocaleDateString(),
                    valor: monto, medio_pago: medio, tipo: "EGRESO_CXP", id_compra: facturaSeleccionada.id, observaciones: obs
                });

                // Actualizar Deuda en Compras
                await update(ref(db, `companies/${nit}/compras_registros/${facturaSeleccionada.id}`), {
                    saldo: facturaSeleccionada.saldo - monto,
                    abonado: (facturaSeleccionada.abonado || 0) + monto
                });

            } else {
                // Gasto General
                const desc = document.getElementById('descOtro').value;
                const valor = parseFloat(document.getElementById('valorOtro').value);
                // Si no seleccionÃ³ proveedor en el buscador, usamos lo que haya escrito en concepto o pedimos un nombre
                const benef = prov || "Gasto General"; 

                if (!desc || !valor) return alert("Faltan datos");

                await push(ref(db, `companies/${nit}/egresos`), {
                    fecha: Date.now(), beneficiario: benef, concepto: desc, valor: valor, 
                    medio_pago: medio, tipo: "EGRESO_GASTO", observaciones: obs
                });
            }

            alert("âœ… Egreso Registrado Correctamente");
            
            // Limpieza
            document.getElementById('observaciones').value = "";
            document.getElementById('txtTotalEgreso').innerText = "$0";
            if (modo === 'otro') { document.getElementById('descOtro').value = ""; document.getElementById('valorOtro').value = ""; }
            else { 
                facturaSeleccionada = null;
                document.querySelectorAll('.input-abono').forEach(i => { i.disabled = true; i.value = ''; });
                document.querySelectorAll('tr').forEach(r => r.classList.remove('row-selected'));
                document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
            }

        } catch (e) { alert("Error: " + e.message); }
    };
</script>
</body>
</html>
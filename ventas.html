<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventas - Distribuci√≥n Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 100%; max-width: 1100px; }
        h2 { color: #e67e22; border-bottom: 3px solid #d35400; padding-bottom: 15px; margin-top: 0; }
        label { font-weight: bold; font-size: 0.9rem; color: #555; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; background: #fafafa; }
        .row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
        .col { flex: 1; position: relative; }
        .lista-resultados { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
        .item-resultado { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .item-resultado:hover { background: #fdf2e9; color: #d35400; }
        button { cursor: pointer; font-weight: bold; border: none; border-radius: 6px; }
        .btn-back { background: #95a5a6; color: white; padding: 8px 15px; margin-bottom: 20px; }
        .btn-add { background: #2980b9; color: white; padding: 12px; height: 100%; width: 100%; }
        .btn-final { background: #27ae60; color: white; padding: 15px; width: 100%; font-size: 1.5rem; margin-top: 20px; }
        .btn-plus { background: #27ae60; color: white; width: 50px; height: 46px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; }
        
        /* BOTONES ACCION */
        .acciones-wrapper { display: flex; gap: 5px; justify-content: center; }
        .btn-eye { background: #f39c12; color: white; padding: 6px 10px; font-size: 1rem; }
        .btn-edit { background: #2980b9; color: white; padding: 6px 10px; font-size: 1rem; }
        .btn-trash { background: #e74c3c; color: white; padding: 6px 10px; font-size: 1rem; }
        .btn-danger { background: #c0392b; color: white; padding: 5px 10px; font-size: 0.9rem; }

        #selectorLotes { display: none; background: #eaf2f8; padding: 15px; border: 1px solid #3498db; border-radius: 6px; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #eee; }
        th { background: #fdf2e9; text-align: left; padding: 12px; color: #d35400; font-size: 0.9rem; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.85rem; vertical-align: middle; }
        .totales-box { text-align:right; margin-top:15px; padding:15px; background:#fffbf0; border-radius:8px; border: 1px solid #eee; }
        .totales-row { display: flex; justify-content: flex-end; gap: 20px; margin-bottom: 5px; font-size: 1.1rem; color: #555; }
        .total-final { font-size: 1.4rem; color: #d35400; font-weight: bold; border-top: 2px solid #ccc; padding-top: 10px; }
        .modo-edicion { border: 2px solid #f39c12; background: #fef9e7; padding: 10px; margin-bottom: 15px; border-radius: 6px; display:none; color: #d35400; font-weight: bold; text-align: center; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; overflow-y: auto; }
        .modal-content { background: white; width: 500px; margin: 5% auto; padding: 25px; border-radius: 12px; position: relative; }
        .close-modal { background: #e74c3c; color: white; width: 100%; padding: 10px; margin-top: 10px; }
        .save-modal { background: #3498db; color: white; width: 100%; padding: 10px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-back" onclick="location.href='menu.html'">‚¨Ö Volver</button>
    <h2>üöö Nueva Venta (Facturaci√≥n)</h2>
    <div id="bannerEdicion" class="modo-edicion">‚ö†Ô∏è MODO EDICI√ìN ACTIVO</div>

    <div class="row">
        <div class="col" style="flex: 10;"><label>Cliente</label><input type="text" id="inputCliente" placeholder="Buscar..." autocomplete="off"><div id="listaCliente" class="lista-resultados"></div></div>
        <div class="col" style="flex: 1;"><label>&nbsp;</label><button class="btn-plus" onclick="window.abrirModal('modalCliente')">+</button></div>
    </div>
    <div class="row">
        <div class="col" style="flex: 10;"><label>Producto</label><input type="text" id="inputProd" placeholder="Buscar..." autocomplete="off"><div id="listaProd" class="lista-resultados"></div></div>
        <div class="col" style="flex: 1;"><label>&nbsp;</label><button class="btn-plus" onclick="window.abrirModal('modalProd')">+</button></div>
    </div>

    <div id="selectorLotes"><label style="color:#2980b9;">üìÖ Selecciona Lote:</label><select id="selLoteEspecifico"><option value="">-- Cargando lotes --</option></select></div>

    <div class="row">
        <div class="col"><label>Cant.</label><input type="number" id="cant" placeholder="1" value="1"></div>
        <div class="col"><label>Precio Unit.</label><input type="number" id="precio" placeholder="$"></div>
        <div class="col"><label>IVA %</label><input type="number" id="tasaIva" readonly style="background:#eee;"></div>
        <div class="col"><label>&nbsp;</label><button class="btn-add" id="btnAddItem">‚¨á A√ëADIR</button></div>
    </div>

    <table>
        <thead style="background:#fff3e0;"><tr><th>Producto</th><th>Cant.</th><th>Base</th><th>IVA</th><th>Total</th><th>X</th></tr></thead>
        <tbody id="tablaVentas"></tbody>
    </table>

    <div class="totales-box">
        <div class="totales-row"><span>Subtotal:</span> <span id="txtSubtotal">$0</span></div>
        <div class="totales-row"><span>Total IVA:</span> <span id="txtIva">$0</span></div>
        <div class="totales-row"><span>Retenci√≥n (%):</span> <input type="number" id="inputRetencion" value="0" style="width:60px;" onchange="renderCarrito()"> <span id="txtRetencion" style="color:#e74c3c;">- $0</span></div>
        <div class="totales-row total-final"><span>Total a Cobrar:</span> <span id="txtTotal">$0</span></div>
    </div>

    <div style="background: #fdf2e9; padding: 15px; margin-top: 20px; border-radius: 8px;">
        <label>M√©todo de Pago:</label>
        <select id="metodoPago"><option value="Efectivo">Efectivo</option><option value="Bancos">Bancos</option><option value="Credito">Credito</option></select>
        <button class="btn-final" id="btnFinalizar">üí∞ CONFIRMAR VENTA</button>
        <button class="btn-danger" id="btnCancelarEdicion" style="display:none; width:100%; margin-top:10px; background:#95a5a6;" onclick="window.limpiarFormulario()">CANCELAR EDICI√ìN</button>
    </div>

    <div style="margin-top:50px;">
        <h3>Historial (√öltimas 5)</h3>
        <table style="width:100%"><tbody id="listaHistorial"></tbody></table>
    </div>
</div>

<div id="modalDetalle" class="modal"><div class="modal-content">
    <h3>üìã Detalle de Venta</h3>
    <p><strong>Cliente:</strong> <span id="lblClienteDetalle"></span></p>
    <table style="width:100%;"><thead><tr><th>Prod</th><th>Cant</th><th>Total</th></tr></thead><tbody id="tablaDetalleItems"></tbody></table>
    <h3 style="text-align:right;" id="lblTotalDetalle"></h3>
    <button class="close-modal" onclick="window.cerrarModal('modalDetalle')">Cerrar</button>
</div></div>

<div id="modalCliente" class="modal"><div class="modal-content"><h3>Nuevo Cliente</h3><input id="ncNombre" placeholder="Nombre"><button class="save-modal" id="btnSaveCliente">Guardar</button><button class="close-modal" onclick="window.cerrarModal('modalCliente')">Cancelar</button></div></div>
<div id="modalProd" class="modal"><div class="modal-content"><h3>Nuevo Producto</h3><input id="npNombre" placeholder="Nombre"><input id="npPrecio" placeholder="Precio"><select id="npIva"><option value="0">0%</option><option value="19">19%</option></select><button class="save-modal" id="btnSaveProd">Guardar</button><button class="close-modal" onclick="window.cerrarModal('modalProd')">Cancelar</button></div></div>

<script type="module">
    import { db, ref, push, onValue, update, remove, get } from './firebase.js';

    const nit = localStorage.getItem('userNit');
    if (!nit) window.location.href = "index.html";

    // VARIABLES GLOBALES
    let carrito = [];
    let todosClientes = [], todosProductos = [], inventarioCompleto = [], ventasCache = [];
    let idEdicion = null, fechaOriginal = null, itemsDevueltos = false; 

    // --- FUNCIONES GLOBALES (CONECTADAS A WINDOW) ---
    window.abrirModal = (id) => document.getElementById(id).style.display = 'block';
    window.cerrarModal = (id) => document.getElementById(id).style.display = 'none';

    // 1. VER DETALLE
    window.verDetalle = (id) => {
        const v = ventasCache.find(x => x.id === id);
        if(!v) return alert("Error: No se encuentra la venta.");
        
        document.getElementById('lblClienteDetalle').innerText = v.cliente;
        document.getElementById('lblTotalDetalle').innerText = `$${v.total.toLocaleString()}`;
        const tb = document.getElementById('tablaDetalleItems'); tb.innerHTML="";
        if(v.items) v.items.forEach(i => tb.innerHTML+=`<tr><td>${i.producto}</td><td>${i.cantidad}</td><td>$${i.totalLinea.toLocaleString()}</td></tr>`);
        window.abrirModal('modalDetalle');
    };

    // 2. ELIMINAR
    window.eliminarVenta = async (idVenta) => {
        if(!confirm("‚ö†Ô∏è ¬øEliminar y devolver stock?")) return;
        const venta = ventasCache.find(v => v.id === idVenta);
        if(!venta) return;
        await restaurarStock(venta);
        await remove(ref(db, `companies/${nit}/ventas/${idVenta}`));
        alert("‚úÖ Eliminado y stock devuelto.");
    };

    // 3. EDITAR
    window.editarVenta = async (idVenta) => {
        const venta = ventasCache.find(v => v.id === idVenta);
        if(!venta) return;
        if(!confirm("‚ö†Ô∏è MODO EDICI√ìN:\n\n1. El stock se devolver√° temporalmente.\n2. Se mantendr√° la fecha original.\n¬øContinuar?")) return;

        try {
            await restaurarStock(venta);
            itemsDevueltos = true;
            idEdicion = idVenta;
            fechaOriginal = venta.fecha;
            
            document.getElementById('inputCliente').value = venta.cliente;
            document.getElementById('metodoPago').value = venta.metodo_pago;
            if(venta.retencion && venta.subtotal > 0) document.getElementById('inputRetencion').value = Math.round((venta.retencion / venta.subtotal) * 100);
            
            carrito = [];
            for(let item of venta.items) {
                let stockMax = 0;
                if(item.idLote) {
                    const snap = await get(ref(db, `companies/${nit}/inventario/${item.idLote}/cantidad`));
                    if(snap.exists()) stockMax = snap.val();
                }
                carrito.push({ ...item, stockActual: stockMax });
            }
            renderCarrito();
            
            document.getElementById('bannerEdicion').style.display='block';
            document.getElementById('btnFinalizar').innerText = "üíæ ACTUALIZAR VENTA";
            document.getElementById('btnCancelarEdicion').style.display='block';
        } catch(e) { alert("Error al iniciar edici√≥n: " + e.message); }
    };

    async function restaurarStock(venta) {
        const updates = {};
        if (venta.items && Array.isArray(venta.items)) {
            for (const item of venta.items) {
                if (item.idLote) {
                    const stockSnap = await get(ref(db, `companies/${nit}/inventario/${item.idLote}/cantidad`));
                    let stockActual = stockSnap.exists() ? parseInt(stockSnap.val()) : 0;
                    updates[`companies/${nit}/inventario/${item.idLote}/cantidad`] = stockActual + parseInt(item.cantidad);
                }
            }
        }
        if (Object.keys(updates).length > 0) await update(ref(db), updates);
    };

    window.limpiarFormulario = () => {
        window.location.reload(); 
    };

    // --- CARGA DE DATOS ---
    onValue(ref(db, `companies/${nit}/clientes`), s => { todosClientes=[]; if(s.exists()) Object.values(s.val()).forEach(c=>todosClientes.push(c)); });
    onValue(ref(db, `companies/${nit}/productos`), s => { todosProductos=[]; if(s.exists()) Object.values(s.val()).forEach(p=>todosProductos.push(p)); });
    onValue(ref(db, `companies/${nit}/inventario`), s => { inventarioCompleto=[]; if(s.exists()) s.forEach(c => { let i=c.val(); i.idFirebase=c.key; inventarioCompleto.push(i); }); });

    // --- HISTORIAL ---
    onValue(ref(db, `companies/${nit}/ventas`), (snapshot) => {
        const tbody = document.getElementById('listaHistorial'); tbody.innerHTML = ""; ventasCache = []; 
        if (!snapshot.exists()) return;
        
        let ventas = [];
        snapshot.forEach((child) => { let v=child.val(); v.id = child.key; ventas.push(v); });
        ventas.sort((a, b) => b.fecha - a.fecha);
        ventasCache = ventas;
        
        ventas.slice(0, 5).forEach(v => {
            tbody.innerHTML += `<tr>
                    <td>${new Date(v.fecha).toLocaleDateString()}</td>
                    <td>${v.cliente}</td>
                    <td>$${v.total.toLocaleString()}</td>
                    <td class="acciones-wrapper">
                        <button class="btn-eye" onclick="window.verDetalle('${v.id}')">üëÅÔ∏è</button>
                        <button class="btn-edit" onclick="window.editarVenta('${v.id}')">‚úèÔ∏è</button>
                        <button class="btn-trash" onclick="window.eliminarVenta('${v.id}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
        });
    });

    // --- LOGICA INTERNA ---
    const buscar = (inp, div, data, onPick) => {
        const d = document.getElementById(div);
        const mostrar = (t) => {
            d.innerHTML=''; let r = t===""?data.slice(0,10):data.filter(x=>x.nombre.toLowerCase().includes(t.toLowerCase()));
            if(!r.length) {d.style.display='none'; return;}
            r.forEach(i=>{ const e=document.createElement('div'); e.className='item-resultado'; e.innerHTML = `${i.nombre} ${i.precio ? '<small>($'+i.precio+')</small>' : ''}`; e.onclick=()=>{onPick(i); d.style.display='none';}; d.appendChild(e); }); d.style.display='block';
        };
        inp.addEventListener('input', (e)=>mostrar(e.target.value)); inp.addEventListener('focus', ()=>mostrar(inp.value));
    };
    buscar(document.getElementById('inputCliente'), 'listaCliente', todosClientes, (c)=>document.getElementById('inputCliente').value=c.nombre);
    buscar(document.getElementById('inputProd'), 'listaProd', todosProductos, (p)=>{ document.getElementById('inputProd').value = p.nombre; document.getElementById('precio').value = p.precio; document.getElementById('tasaIva').value = p.iva || 0; buscarLotesDisponibles(p.nombre); });
    document.addEventListener('click', (e)=>{if(!e.target.matches('input')){document.getElementById('listaCliente').style.display='none'; document.getElementById('listaProd').style.display='none';}});

    function buscarLotesDisponibles(nombre) {
        const sel = document.getElementById('selLoteEspecifico'); sel.innerHTML = '<option value="">-- Seleccione Lote --</option>';
        const lotes = inventarioCompleto.filter(i => i.producto === nombre && i.tipo === 'COMPRA' && parseInt(i.cantidad) > 0);
        if(lotes.length > 0) { document.getElementById('selectorLotes').style.display = 'block'; lotes.sort((a,b)=> (a.vence>b.vence)?1:-1).forEach(l => { const op = document.createElement('option'); op.value=l.idFirebase; op.text=`${l.lote} (${l.cantidad})`; op.dataset.max=l.cantidad; sel.appendChild(op); }); } else { document.getElementById('selectorLotes').style.display='none'; alert("Sin stock"); }
    }

    document.getElementById('btnAddItem').onclick = () => {
        const producto = document.getElementById('inputProd').value; const cantidad = parseInt(document.getElementById('cant').value); const precio = parseFloat(document.getElementById('precio').value); const tasaIva = parseFloat(document.getElementById('tasaIva').value) || 0; const sel = document.getElementById('selLoteEspecifico');
        if(!producto || !cantidad || !precio) return alert("Faltan datos");
        if(sel.offsetParent !== null && !sel.value) return alert("Elige lote");
        const subtotalBase = cantidad * precio; const valorIva = subtotalBase * (tasaIva / 100);
        let itemData = { producto, cantidad, precio, tasaIva, subtotalBase, valorIva, totalLinea: subtotalBase + valorIva, idLote:null };
        if(sel.value) { const max = parseInt(sel.options[sel.selectedIndex].dataset.max); if(cantidad > max) return alert("Stock insuficiente"); itemData.idLote = sel.value; itemData.stockActual = max; }
        carrito.push(itemData); renderCarrito(); document.getElementById('inputProd').value=""; document.getElementById('selectorLotes').style.display='none';
    };

    window.renderCarrito = () => {
        const tbody = document.getElementById('tablaVentas'); tbody.innerHTML = ""; let sumaBase = 0, sumaIva = 0;
        carrito.forEach((item, i) => { sumaBase += item.subtotalBase; sumaIva += item.valorIva; tbody.innerHTML += `<tr><td>${item.producto}</td><td>${item.cantidad}</td><td>$${item.subtotalBase.toLocaleString()}</td><td>$${item.valorIva.toLocaleString()}</td><td>$${item.totalLinea.toLocaleString()}</td><td><button class="btn-danger" onclick="eliminarItem(${i})">X</button></td></tr>`; });
        const tasaRet = parseFloat(document.getElementById('inputRetencion').value) || 0; const valorRet = sumaBase * (tasaRet / 100);
        document.getElementById('txtSubtotal').innerText = `$${sumaBase.toLocaleString()}`; document.getElementById('txtIva').innerText = `$${sumaIva.toLocaleString()}`; document.getElementById('txtTotal').innerText = `$${((sumaBase + sumaIva) - valorRet).toLocaleString()}`;
        window.tempTotales = { sumaBase, sumaIva, valorRet, granTotal: (sumaBase + sumaIva) - valorRet };
        window.eliminarItem = (i) => { carrito.splice(i,1); renderCarrito(); };
    };

    document.getElementById('btnFinalizar').onclick = async () => {
        const cliente = document.getElementById('inputCliente').value; if(!carrito.length || !cliente) return alert("Faltan datos");
        const { sumaBase, sumaIva, valorRet, granTotal } = window.tempTotales;
        const fechaRegistro = idEdicion ? fechaOriginal : Date.now();
        const dataVenta = { cliente, items: carrito, metodo_pago: document.getElementById('metodoPago').value, fecha: fechaRegistro, tipo: "VENTA", subtotal: sumaBase, total_iva: sumaIva, retencion: valorRet, total: granTotal, saldo: document.getElementById('metodoPago').value==='Credito'?granTotal:0, abonado: document.getElementById('metodoPago').value==='Credito'?0:granTotal, estado_entrega: "PENDIENTE" };
        try {
            const updates = {};
            carrito.forEach(i => { if(i.idLote) updates[`companies/${nit}/inventario/${i.idLote}/cantidad`] = i.stockActual - i.cantidad; });
            if(idEdicion) updates[`companies/${nit}/ventas/${idEdicion}`] = dataVenta; else { const newKey = push(ref(db, `companies/${nit}/ventas`)).key; updates[`companies/${nit}/ventas/${newKey}`] = dataVenta; }
            await update(ref(db), updates); alert("‚úÖ Guardado"); window.limpiarFormulario();
        } catch(e) { alert("Error: " + e.message); }
    };

    document.getElementById('btnSaveCliente').onclick = async () => { const n=document.getElementById('ncNombre').value; if(n){await push(ref(db, `companies/${nit}/clientes`), {nombre:n}); window.cerrarModal('modalCliente'); }};
    document.getElementById('btnSaveProd').onclick = async () => { const n=document.getElementById('npNombre').value, p=document.getElementById('npPrecio').value, i=document.getElementById('npIva').value; if(n){ await push(ref(db, `companies/${nit}/productos`), {nombre:n, precio:parseFloat(p), iva:parseInt(i)}); window.cerrarModal('modalProd'); }};
</script>
</body>
</html>
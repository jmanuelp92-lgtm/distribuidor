<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras - Distribuci√≥n Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 100%; max-width: 1200px; }
        h2 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 15px; margin-top: 0; }
        
        label { font-weight: bold; font-size: 0.9rem; color: #555; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; transition: 0.3s; background: #fafafa; }
        input:focus { border-color: #3498db; outline: none; background: white; }

        .row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
        .col { flex: 1; position: relative; }

        .lista-resultados { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .item-resultado { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .item-resultado:hover { background: #eaf2f8; }
        
        button { cursor: pointer; font-weight: bold; border: none; border-radius: 6px; }
        .btn-back { background: #95a5a6; color: white; padding: 8px 15px; margin-bottom: 20px; }
        .btn-plus { background: #27ae60; color: white; width: 50px; height: 46px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; }
        .btn-add { background: #3498db; color: white; padding: 12px; height: 100%; width: 100%; }
        .btn-save { background: #27ae60; color: white; padding: 15px; width: 100%; font-size: 1.2rem; margin-top: 20px; }
        
        /* BOTONES ACCI√ìN */
        .btn-eye { background: #f39c12; color: white; padding: 5px 10px; font-size: 1.1rem; border-radius: 4px; margin-right:5px; }
        .btn-trash { background: #e74c3c; color: white; padding: 5px 10px; font-size: 1.1rem; border-radius: 4px; }
        .btn-danger { background: #e74c3c; color: white; padding: 5px 10px; font-size: 0.9rem; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #eee; }
        th { background: #f8f9fa; text-align: left; padding: 12px; color: #333; font-size: 0.9rem; border-bottom: 2px solid #ddd; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; vertical-align: middle; }
        
        .historial-section { margin-top: 40px; border-top: 2px dashed #ccc; padding-top: 20px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; overflow-y: auto; }
        .modal-content { background: white; width: 500px; margin: 5% auto; padding: 25px; border-radius: 12px; position:relative; }
        .close-modal { background: #e74c3c; color: white; width: 100%; padding: 10px; margin-top: 10px; }
        .save-modal { background: #3498db; color: white; width: 100%; padding: 10px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-back" onclick="location.href='menu.html'">‚¨Ö Volver</button>
    <h2>üì¶ Entrada de Mercanc√≠a (Compras)</h2>

    <div class="row">
        <div class="col" style="flex: 6;">
            <label>Proveedor</label>
            <input type="text" id="inputProv" placeholder="Clic para buscar..." autocomplete="off">
            <div id="listaProv" class="lista-resultados"></div>
        </div>
        <div class="col" style="flex: 1;">
            <label>&nbsp;</label>
            <button class="btn-plus" onclick="window.abrirModal('modalProv')">+</button>
        </div>
        <div class="col" style="flex: 3;">
            <label>Fecha Factura</label>
            <input type="date" id="fechaCompra">
        </div>
    </div>

    <div class="row">
        <div class="col" style="flex: 10;">
            <label>Producto</label>
            <input type="text" id="inputProd" placeholder="Buscar..." autocomplete="off">
            <div id="listaProd" class="lista-resultados"></div>
        </div>
        <div class="col" style="flex: 1;"><label>&nbsp;</label><button class="btn-plus" onclick="window.abrirModal('modalProd')">+</button></div>
    </div>

    <div class="row">
        <div class="col"><label>Cant.</label><input type="number" id="cant" placeholder="1" value="1"></div>
        <div class="col"><label>Costo Unit.</label><input type="number" id="costo" placeholder="$"></div>
        <div class="col"><label>Lote / Ref</label><input type="text" id="lote" placeholder="Lote123"></div>
        <div class="col"><label>Vence Prod.</label><input type="date" id="vence"></div>
        <div class="col"><label>&nbsp;</label><button class="btn-add" id="btnAddItem">‚¨á A√ëADIR</button></div>
    </div>

    <table>
        <thead><tr><th>Producto</th><th>Cant.</th><th>Costo</th><th>Lote / Vence</th><th>Acci√≥n</th></tr></thead>
        <tbody id="tablaItems"></tbody>
    </table>

    <div style="text-align:right; font-size:1.3rem; font-weight:bold; margin-top:10px; color:#2c3e50;" id="txtTotalCompra">Total: $0</div>

    <div style="background: #eaf2f8; padding: 15px; border-radius: 8px; margin-top: 20px;">
        <label>M√©todo de Pago:</label>
        <select id="metodoPago" style="border: 2px solid #3498db;">
            <option value="Efectivo">üíµ Efectivo (Contado)</option>
            <option value="Bancos">üè¶ Bancos (Contado)</option>
            <option value="Credito">üìù Cr√©dito (Cuenta por Pagar)</option>
        </select>
        <button class="btn-save" id="btnGuardarTodo">‚úÖ GUARDAR ENTRADA</button>
    </div>

    <div class="historial-section">
        <h3>üìú Historial de Compras (Numerado)</h3>
        <table>
            <thead>
                <tr>
                    <th style="width:50px;">No.</th>
                    <th>Fecha</th>
                    <th>Proveedor</th>
                    <th>Total</th>
                    <th>Saldo</th>
                    <th style="text-align:center;">Acciones</th>
                </tr>
            </thead>
            <tbody id="listaHistorial">
                <tr><td colspan="6" style="text-align:center;">Cargando historial...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="modalDetalle" class="modal">
    <div class="modal-content">
        <h3 style="color:#2c3e50;">üìã Detalle Compra #<span id="lblNumCompra"></span></h3>
        <p><strong>Proveedor:</strong> <span id="lblProvDetalle"></span></p>
        <table style="width:100%; margin-top:10px;"><thead><tr style="background:#f2f2f2;"><th>Prod</th><th>Cant</th><th>Subtotal</th></tr></thead><tbody id="tablaDetalleItems"></tbody></table>
        <button class="close-modal" onclick="window.cerrarModal('modalDetalle')">Cerrar</button>
    </div>
</div>

<div id="modalProv" class="modal"><div class="modal-content">
    <h3>üë§ Nuevo Proveedor</h3>
    <input type="text" id="newProvName" placeholder="Nombre">
    <input type="text" id="newProvDoc" placeholder="Documento">
    <button class="save-modal" id="btnSaveProv">Guardar</button>
    <button class="close-modal" onclick="window.cerrarModal('modalProv')">Cancelar</button>
</div></div>

<div id="modalProd" class="modal"><div class="modal-content">
    <h3>üçé Nuevo Producto</h3>
    <label>Nombre</label><input type="text" id="newProdName">
    <label>Precio Venta</label><input type="number" id="newProdPrice">
    <button class="save-modal" id="btnSaveProd">Guardar</button>
    <button class="close-modal" onclick="window.cerrarModal('modalProd')">Cancelar</button>
</div></div>

<script type="module">
    import { db, ref, push, onValue, remove, get, update } from './firebase.js';

    window.abrirModal = (id) => document.getElementById(id).style.display = 'block';
    window.cerrarModal = (id) => document.getElementById(id).style.display = 'none';

    // FECHA DE HOY POR DEFECTO
    document.getElementById('fechaCompra').valueAsDate = new Date();

    const nit = localStorage.getItem('userNit');
    if (!nit) window.location.href = "index.html";

    let listaIngreso = [];
    let todosClientes = [];
    let todosProductos = [];
    let comprasCache = [];

    // CARGA DE DATOS
    onValue(ref(db, `companies/${nit}/clientes`), s => { todosClientes=[]; if(s.exists()) Object.values(s.val()).forEach(c=>todosClientes.push(c)); });
    onValue(ref(db, `companies/${nit}/productos`), s => { todosProductos=[]; if(s.exists()) Object.values(s.val()).forEach(p=>todosProductos.push(p)); });

    // BUSCADORES
    const inpProv = document.getElementById('inputProv');
    const mostrarProv = (txt="") => {
        const div=document.getElementById('listaProv'); div.innerHTML='';
        let res = txt===""?todosClientes.slice(0,10):todosClientes.filter(c=>c.nombre.toLowerCase().includes(txt.toLowerCase()));
        if(!res.length){div.style.display='none';return;}
        res.forEach(c=>{const d=document.createElement('div'); d.className='item-resultado'; d.innerText=c.nombre; d.onclick=()=>{inpProv.value=c.nombre; div.style.display='none';}; div.appendChild(d);}); div.style.display='block';
    };
    inpProv.addEventListener('input',(e)=>mostrarProv(e.target.value)); inpProv.addEventListener('focus',()=>mostrarProv(inpProv.value));

    const inpProd = document.getElementById('inputProd');
    const mostrarProd = (txt="") => {
        const div=document.getElementById('listaProd'); div.innerHTML='';
        let res = txt===""?todosProductos.slice(0,10):todosProductos.filter(p=>p.nombre.toLowerCase().includes(txt.toLowerCase()));
        if(!res.length){div.style.display='none';return;}
        res.forEach(p=>{const d=document.createElement('div'); d.className='item-resultado'; d.innerText=p.nombre; d.onclick=()=>{inpProd.value=p.nombre; div.style.display='none'; document.getElementById('cant').focus();}; div.appendChild(d);}); div.style.display='block';
    };
    inpProd.addEventListener('input',(e)=>mostrarProd(e.target.value)); inpProd.addEventListener('focus',()=>mostrarProd(inpProd.value));
    document.addEventListener('click', (e)=>{if(!e.target.matches('input')){document.getElementById('listaProv').style.display='none'; document.getElementById('listaProd').style.display='none';}});

    // CARRITO
    document.getElementById('btnAddItem').onclick = () => {
        const producto = inpProd.value;
        const cantidad = parseInt(document.getElementById('cant').value);
        const costo = parseFloat(document.getElementById('costo').value);
        const lote = document.getElementById('lote').value || "S/L";
        const vence = document.getElementById('vence').value || "N/A";
        if(!producto || !cantidad || isNaN(costo)) return alert("Faltan datos");
        listaIngreso.push({ producto, cantidad, costo, subtotal: cantidad*costo, lote, vence });
        renderTabla();
        inpProd.value=""; document.getElementById('costo').value=""; document.getElementById('lote').value=""; document.getElementById('vence').value=""; document.getElementById('cant').value="1"; inpProd.focus();
    };

    function renderTabla() {
        const tbody = document.getElementById('tablaItems'); tbody.innerHTML = "";
        let total = 0;
        listaIngreso.forEach((item, i) => {
            total += item.subtotal;
            tbody.innerHTML += `<tr><td>${item.producto}</td><td>${item.cantidad}</td><td>$${item.costo}</td><td><small>${item.lote}</small></td><td><button class="btn-danger" onclick="eliminarItem(${i})">X</button></td></tr>`;
        });
        document.getElementById('txtTotalCompra').innerText = `Total: $${total.toLocaleString()}`;
        window.eliminarItem = (i) => { listaIngreso.splice(i,1); renderTabla(); };
    }

    // GUARDAR COMPRA (CON FECHA PERSONALIZADA)
    document.getElementById('btnGuardarTodo').onclick = async () => {
        const proveedor = inpProv.value;
        const metodo = document.getElementById('metodoPago').value;
        const fechaInput = document.getElementById('fechaCompra').value;

        if(!listaIngreso.length || !proveedor) return alert("Faltan datos");
        if(!fechaInput) return alert("Seleccione una fecha para la factura.");

        const fechaTimestamp = new Date(fechaInput + "T12:00:00").getTime();

        const totalCompra = listaIngreso.reduce((acc, item) => acc + item.subtotal, 0);
        let saldoInicial = metodo === 'Credito' ? totalCompra : 0;
        let abonadoInicial = metodo === 'Credito' ? 0 : totalCompra;

        try {
            await push(ref(db, `companies/${nit}/compras_registros`), {
                proveedor, total: totalCompra, metodo_pago: metodo, 
                fecha: fechaTimestamp, // FECHA ELEGIDA
                items: listaIngreso,
                saldo: saldoInicial, abonado: abonadoInicial
            });
            for (let item of listaIngreso) {
                await push(ref(db, `companies/${nit}/inventario`), { ...item, proveedor, fecha_ingreso: fechaTimestamp, tipo: "COMPRA" });
            }
            alert("‚úÖ Entrada Registrada");
            listaIngreso = []; renderTabla(); document.getElementById('inputProv').value = ""; document.getElementById('inputProd').value = "";
        } catch(e) { alert("Error: "+e.message); }
    };

    // HISTORIAL
    onValue(ref(db, `companies/${nit}/compras_registros`), s => {
        const tbody = document.getElementById('listaHistorial'); tbody.innerHTML = ""; comprasCache = [];
        if(!s.exists()) { tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Vac√≠o</td></tr>"; return; }

        let l = []; s.forEach(c => { let d=c.val(); d.idFirebase=c.key; l.push(d); });
        l.sort((a,b) => a.fecha - b.fecha);
        l.forEach((item, index) => item.numeroCompra = index + 1); 
        l.reverse(); comprasCache = l;

        l.forEach(c => {
            const fecha = new Date(c.fecha).toLocaleDateString();
            let saldo = c.saldo !== undefined ? c.saldo : (c.metodo_pago === 'Credito' ? c.total : 0);
            
            tbody.innerHTML += `
                <tr>
                    <td><strong>#${c.numeroCompra}</strong></td>
                    <td><small>${fecha}</small></td>
                    <td>${c.proveedor}</td>
                    <td>$${c.total.toLocaleString()}</td>
                    <td style="color:${saldo > 0 ? 'red' : 'green'}; font-weight:bold;">$${saldo.toLocaleString()}</td>
                    <td style="text-align:center;">
                        <button class="btn-eye" onclick="verDetalle('${c.idFirebase}')">üëÅÔ∏è</button>
                        <button class="btn-trash" onclick="eliminarCompra('${c.idFirebase}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
        });
    });

    // --- FUNCI√ìN ELIMINAR COMPRA CON REVERSO ---
    window.eliminarCompra = async (idCompra) => {
        if(!confirm("‚ö†Ô∏è ¬øEliminar compra?\n\nAl eliminarla, los productos se descontar√°n autom√°ticamente del inventario (si a√∫n existen) y la deuda desaparecer√°.")) return;

        try {
            const snapC = await get(ref(db, `companies/${nit}/compras_registros/${idCompra}`));
            if(!snapC.exists()) return alert("Error: Compra no encontrada");
            const compra = snapC.val();
            const snapInv = await get(ref(db, `companies/${nit}/inventario`));
            const updates = {};

            if(snapInv.exists() && compra.items) {
                compra.items.forEach(itemCompra => {
                    let cantidadABorrar = parseInt(itemCompra.cantidad);
                    const loteCompra = itemCompra.lote || "S/L";

                    snapInv.forEach(childInv => {
                        const itemInv = childInv.val();
                        const keyInv = childInv.key;
                        const loteInv = itemInv.lote || "S/L";

                        if(cantidadABorrar > 0 && itemInv.producto === itemCompra.producto && loteInv === loteCompra) {
                            const stockActual = parseInt(itemInv.cantidad);
                            if(stockActual >= cantidadABorrar) {
                                updates[`companies/${nit}/inventario/${keyInv}/cantidad`] = stockActual - cantidadABorrar;
                                cantidadABorrar = 0;
                            } else {
                                updates[`companies/${nit}/inventario/${keyInv}/cantidad`] = 0;
                                cantidadABorrar -= stockActual;
                            }
                        }
                    });
                });
            }

            if(Object.keys(updates).length > 0) await update(ref(db), updates);
            await remove(ref(db, `companies/${nit}/compras_registros/${idCompra}`));
            alert("‚úÖ Compra eliminada e inventario ajustado.");
        } catch(e) { console.error(e); alert("Error: " + e.message); }
    };

    window.verDetalle = (id) => {
        const c = comprasCache.find(x => x.idFirebase === id);
        if(!c) return;
        document.getElementById('lblNumCompra').innerText = c.numeroCompra;
        document.getElementById('lblProvDetalle').innerText = c.proveedor;
        const tb = document.getElementById('tablaDetalleItems'); tb.innerHTML="";
        if(c.items) c.items.forEach(i => tb.innerHTML+=`<tr><td>${i.producto}</td><td>${i.cantidad}</td><td>$${i.subtotal.toLocaleString()}</td></tr>`);
        window.abrirModal('modalDetalle');
    };

    document.getElementById('btnSaveProv').onclick = async () => { const nombre = document.getElementById('newProvName').value; if(nombre) { await push(ref(db, `companies/${nit}/clientes`), { nombre, documento: document.getElementById('newProvDoc').value }); alert("Proveedor Creado"); window.cerrarModal('modalProv'); document.getElementById('inputProv').value = nombre; }};
    document.getElementById('btnSaveProd').onclick = async () => { const nombre = document.getElementById('newProdName').value; if(nombre) { await push(ref(db, `companies/${nit}/productos`), { nombre, precio: document.getElementById('newProdPrice').value }); alert("Producto Creado"); window.cerrarModal('modalProd'); document.getElementById('inputProd').value = nombre; }};
</script>
</body>
</html>
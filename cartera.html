<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartera - Distribuci√≥n Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 100%; max-width: 950px; }
        h2 { color: #27ae60; border-bottom: 3px solid #2ecc71; padding-bottom: 15px; margin-top: 0; }
        
        /* LAYOUT FLEXIBLE (Para poner el bot√≥n + al lado) */
        .row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
        .col { flex: 1; position: relative; }

        label { font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; background: #fafafa; }
        
        /* BOTONES */
        .btn-plus { background: #27ae60; color: white; width: 50px; height: 46px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; border: none; border-radius: 6px; cursor: pointer; }
        .btn-save { background: #27ae60; color: white; width: 100%; padding: 15px; border: none; border-radius: 6px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top:20px;}
        .btn-back { background: #95a5a6; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 20px; }
        .btn-trash { background: #e74c3c; color: white; border: none; padding: 5px 10px; font-size: 1.1rem; border-radius: 4px; cursor: pointer; }
        .save-modal { background: #2980b9; color: white; width: 100%; padding: 10px; margin-top: 15px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; }
        .close-modal { background: #e74c3c; color: white; width: 100%; padding: 10px; margin-top: 10px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; }

        /* TABLAS */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid #eee; }
        th { background: #e8f5e9; text-align: left; padding: 10px; color: #1e8449; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .switch-container { display: flex; gap: 20px; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        #seccionFacturas, #seccionOtro { display: none; }
        .total-box { text-align: right; font-size: 1.3rem; font-weight: bold; margin: 20px 0; color: #27ae60; }
        
        .lista-resultados { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
        .item-resultado { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .item-resultado:hover { background: #e8f5e9; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; overflow-y: auto; }
        .modal-content { background: white; width: 400px; margin: 5% auto; padding: 25px; border-radius: 12px; position: relative; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-back" onclick="location.href='menu.html'">‚¨Ö Volver</button>
    <h2>üí∞ Gesti√≥n de Cartera (Recaudos)</h2>

    <div class="row">
        <div class="col" style="flex: 10;">
            <label>Buscar Cliente</label>
            <input type="text" id="inputCli" placeholder="Escribe para buscar..." autocomplete="off">
            <div id="listaCli" class="lista-resultados"></div>
        </div>
        <div class="col" style="flex: 1;">
            <label>&nbsp;</label>
            <button class="btn-plus" onclick="window.abrirModal('modalCliente')">+</button>
        </div>
    </div>

    <div class="switch-container">
        <label><input type="radio" name="tipoIngreso" value="factura" checked onchange="window.cambiarModo()"> Abono a Factura (CXC)</label>
        <label><input type="radio" name="tipoIngreso" value="otro" onchange="window.cambiarModo()"> Otro Ingreso</label>
    </div>

    <div id="seccionFacturas">
        <p style="color:#777;">Seleccione la factura a la que el cliente va a abonar:</p>
        <table>
            <thead><tr><th>Sel</th><th>Fecha</th><th>Total Original</th><th>Abonado</th><th>Saldo Pendiente</th><th>Abonar Ahora</th></tr></thead>
            <tbody id="listaFacturas"><tr><td colspan="6" style="text-align:center;">Busque un cliente para ver sus deudas.</td></tr></tbody>
        </table>
    </div>

    <div id="seccionOtro">
        <label>Concepto</label><input type="text" id="descOtro" placeholder="Ej: Pr√©stamo, Aporte socio...">
        <label>Valor</label><input type="number" id="valorOtro" placeholder="$ 0">
    </div>

    <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-top:20px;">
        <label>Destino del dinero</label>
        <select id="medioPago"><option>Caja General</option><option>Bancos</option></select>
        <label>Observaciones</label><textarea id="observaciones"></textarea>
    </div>

    <div class="total-box" id="txtTotalIngreso">Total Recibido: $0</div>
    <button class="btn-save" id="btnGuardar">üü¢ REGISTRAR INGRESO</button>

    <div style="margin-top:50px; border-top:2px dashed #ccc; padding-top:20px;">
        <h3>üìú Historial de Recibos de Caja</h3>
        <table>
            <thead><tr><th>Fecha</th><th>Cliente / Origen</th><th>Concepto</th><th>Valor</th><th>Tipo</th><th>Acci√≥n</th></tr></thead>
            <tbody id="tablaHistorialIngresos"></tbody>
        </table>
    </div>
</div>

<div id="modalCliente" class="modal"><div class="modal-content">
    <h3>üë§ Nuevo Tercero</h3>
    <input type="text" id="ncNombre" placeholder="Nombre">
    <input type="text" id="ncDoc" placeholder="Documento" style="margin-top:10px;">
    <input type="text" id="ncTel" placeholder="Tel√©fono" style="margin-top:10px;">
    <input type="text" id="ncFinca" placeholder="Finca" style="margin-top:10px;">
    <button class="save-modal" id="btnSaveCliente">Guardar</button>
    <button class="close-modal" onclick="window.cerrarModal('modalCliente')">Cancelar</button>
</div></div>

<script type="module">
    import { db, ref, push, onValue, update, remove, get } from './firebase.js';

    window.abrirModal = (id) => document.getElementById(id).style.display = 'block';
    window.cerrarModal = (id) => document.getElementById(id).style.display = 'none';

    const nit = localStorage.getItem('userNit');
    if (!nit) window.location.href = "index.html";

    let todosClientes = [];
    let todosRecibos = [];
    let facturaSeleccionada = null; 

    // CARGA DE DATOS
    onValue(ref(db, `companies/${nit}/clientes`), s => { todosClientes=[]; if(s.exists()) Object.values(s.val()).forEach(c=>todosClientes.push(c)); });
    
    // CARGAR HISTORIAL DE RECIBOS
    onValue(ref(db, `companies/${nit}/recibos`), (snap) => {
        todosRecibos = [];
        if (snap.exists()) { snap.forEach(c => { let v=c.val(); v.idFirebase=c.key; todosRecibos.push(v); }); }
        actualizarTablaHistorial(); 
    });

    function actualizarTablaHistorial() {
        const tbody = document.getElementById('tablaHistorialIngresos'); tbody.innerHTML = "";
        todosRecibos.sort((a,b) => b.fecha - a.fecha);
        
        todosRecibos.slice(0, 30).forEach(r => {
            tbody.innerHTML += `
                <tr>
                    <td>${new Date(r.fecha).toLocaleDateString()}</td>
                    <td><strong>${r.cliente}</strong></td>
                    <td>${r.concepto}</td>
                    <td style="color:#27ae60; font-weight:bold;">$${parseFloat(r.valor).toLocaleString()}</td>
                    <td>${r.tipo === 'INGRESO_CXC' ? 'Abono CXC' : 'Otro'}</td>
                    <td><button class="btn-trash" onclick="eliminarRecibo('${r.idFirebase}')">üóëÔ∏è</button></td>
                </tr>`;
        });
    }

    window.eliminarRecibo = async (idRecibo) => {
        if(!confirm("‚ö†Ô∏è ¬øEliminar este recibo? \n\nSi es un abono a una venta a cr√©dito, la deuda del cliente volver√° a subir.")) return;
        try {
            const snap = await get(ref(db, `companies/${nit}/recibos/${idRecibo}`));
            if (!snap.exists()) return alert("Recibo no encontrado");
            const recibo = snap.val();

            if (recibo.tipo === 'INGRESO_CXC' && recibo.id_venta) {
                const ventaRef = ref(db, `companies/${nit}/ventas/${recibo.id_venta}`);
                const ventaSnap = await get(ventaRef);
                if (ventaSnap.exists()) {
                    const venta = ventaSnap.val();
                    await update(ventaRef, { 
                        saldo: (venta.saldo || 0) + parseFloat(recibo.valor),
                        abonado: (venta.abonado || 0) - parseFloat(recibo.valor)
                    });
                }
            }
            await remove(ref(db, `companies/${nit}/recibos/${idRecibo}`));
            alert("‚úÖ Recibo eliminado y saldo ajustado.");
        } catch(e) { alert("Error: " + e.message); }
    };

    const inpCli = document.getElementById('inputCli');
    const mostrarCli = (txt="") => {
        const div = document.getElementById('listaCli'); div.innerHTML='';
        let res = txt==="" ? todosClientes.slice(0,10) : todosClientes.filter(c=>c.nombre.toLowerCase().includes(txt.toLowerCase()));
        if(!res.length){ div.style.display='none'; return;}
        res.forEach(c=>{const d=document.createElement('div'); d.className='item-resultado'; d.innerText=c.nombre; d.onclick=()=>{inpCli.value=c.nombre; div.style.display='none'; cargarDeudas(c.nombre);}; div.appendChild(d);}); div.style.display='block';
    };
    inpCli.addEventListener('input', (e)=>mostrarCli(e.target.value)); inpCli.addEventListener('focus', ()=>mostrarCli(inpCli.value));
    
    function cargarDeudas(nombre) {
        const tbody = document.getElementById('listaFacturas'); tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Buscando deudas...</td></tr>";
        onValue(ref(db, `companies/${nit}/ventas`), (snap) => {
            tbody.innerHTML = "";
            let hayDeudas = false;
            if (snap.exists()) {
                snap.forEach(c => {
                    const venta = c.val();
                    if (venta.cliente === nombre && venta.saldo > 0) {
                        hayDeudas = true;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td><input type="radio" name="facturaSel" onclick="selFactura('${c.key}', ${venta.saldo})"></td><td>${new Date(venta.fecha).toLocaleDateString()}</td><td>$${venta.total.toLocaleString()}</td><td>$${(venta.abonado||0).toLocaleString()}</td><td style="color:red; font-weight:bold;">$${venta.saldo.toLocaleString()}</td><td><input id="abono_${c.key}" disabled type="number" style="width:120px;" placeholder="Valor a abonar"></td>`;
                        tr.querySelector(`#abono_${c.key}`).oninput=(e)=>{document.getElementById('txtTotalIngreso').innerText=`Total Recibido: $${parseFloat(e.target.value||0).toLocaleString()}`;};
                        tbody.appendChild(tr);
                    }
                });
            }
            if(!hayDeudas) tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:green;'>‚úÖ Este cliente est√° a paz y salvo.</td></tr>";
        }, {onlyOnce: true});
    }

    window.selFactura = (key, saldo) => {
        document.querySelectorAll('input[type=number]').forEach(i=>{i.disabled=true;i.value=''});
        const inp = document.getElementById(`abono_${key}`);
        inp.disabled=false; inp.value=saldo; inp.focus(); 
        facturaSeleccionada = {id: key, saldo: saldo};
        document.getElementById('txtTotalIngreso').innerText=`Total Recibido: $${saldo.toLocaleString()}`;
    };

    window.cambiarModo = () => {
        const m = document.querySelector('input[name="tipoIngreso"]:checked').value;
        document.getElementById('seccionFacturas').style.display = m==='factura'?'block':'none';
        document.getElementById('seccionOtro').style.display = m==='otro'?'block':'none';
    };
    cambiarModo();

    document.getElementById('btnGuardar').onclick = async () => {
        const modo = document.querySelector('input[name="tipoIngreso"]:checked').value;
        const cli = document.getElementById('inputCli').value;
        try {
            if(modo==='factura') {
                if(!facturaSeleccionada) return alert("Seleccione una factura para abonar.");
                const val = parseFloat(document.getElementById(`abono_${facturaSeleccionada.id}`).value);
                if(!val || val <= 0) return alert("Ingrese un valor v√°lido.");
                if(val > facturaSeleccionada.saldo) return alert("El abono no puede ser mayor al saldo pendiente.");

                await push(ref(db, `companies/${nit}/recibos`), { fecha: Date.now(), cliente: cli, concepto: "Abono a Factura", valor: val, tipo: "INGRESO_CXC", id_venta: facturaSeleccionada.id });
                
                const ventaRef = ref(db, `companies/${nit}/ventas/${facturaSeleccionada.id}`);
                const snap = await get(ventaRef);
                const v = snap.val();
                await update(ventaRef, { saldo: v.saldo - val, abonado: (v.abonado||0) + val });

            } else {
                const val = parseFloat(document.getElementById('valorOtro').value);
                if(!val) return alert("Ingrese el valor.");
                await push(ref(db, `companies/${nit}/recibos`), { fecha: Date.now(), cliente: cli||"Varios", concepto: document.getElementById('descOtro').value, valor: val, tipo: "INGRESO_OTRO" });
            }
            alert("‚úÖ Ingreso registrado correctamente."); location.reload();
        } catch(e) { alert(e.message); }
    };

    // GUARDAR CLIENTE NUEVO (BOT√ìN +)
    document.getElementById('btnSaveCliente').onclick = async () => {
        const nombre = document.getElementById('ncNombre').value;
        const documento = document.getElementById('ncDoc').value;
        if(nombre && documento) {
            await push(ref(db, `companies/${nit}/clientes`), { nombre, documento, telefono: document.getElementById('ncTel').value, finca: document.getElementById('ncFinca').value });
            alert("Cliente creado"); window.cerrarModal('modalCliente'); document.getElementById('inputCli').value = nombre;
        } else {
            alert("Nombre y Documento son obligatorios");
        }
    };
</script>
</body>
</html>
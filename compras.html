<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras - Distribuci√≥n Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 100%; max-width: 1200px; }
        h2 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 15px; margin-top: 0; }
        
        label { font-weight: bold; font-size: 0.9rem; color: #555; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; transition: 0.3s; background: #fafafa; }
        input:focus { border-color: #3498db; outline: none; background: white; }

        .row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
        .col { flex: 1; position: relative; }

        .lista-resultados { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .item-resultado { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .item-resultado:hover { background: #eaf2f8; }
        
        button { cursor: pointer; font-weight: bold; border: none; border-radius: 6px; }
        .btn-back { background: #95a5a6; color: white; padding: 8px 15px; margin-bottom: 20px; }
        .btn-plus { background: #27ae60; color: white; width: 50px; height: 46px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; }
        .btn-add { background: #3498db; color: white; padding: 12px; height: 100%; width: 100%; }
        .btn-save { background: #27ae60; color: white; padding: 15px; width: 100%; font-size: 1.2rem; margin-top: 20px; }
        .btn-danger { background: #e74c3c; color: white; padding: 5px 10px; font-size: 0.9rem; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #eee; }
        th { background: #f8f9fa; text-align: left; padding: 12px; color: #333; font-size: 0.9rem; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; vertical-align: middle; }
        
        .historial-section { margin-top: 50px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .badge { padding: 4px 10px; border-radius: 12px; color: white; font-size: 0.8rem; font-weight: bold; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; overflow-y: auto; }
        .modal-content { background: white; width: 400px; margin: 5% auto; padding: 25px; border-radius: 12px; }
        .close-modal { background: #e74c3c; color: white; width: 100%; padding: 10px; margin-top: 10px; }
        .save-modal { background: #3498db; color: white; width: 100%; padding: 10px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-back" onclick="location.href='menu.html'">‚¨Ö Volver</button>
    <h2>üì¶ Entrada de Mercanc√≠a</h2>

    <div class="row">
        <div class="col" style="flex: 10;">
            <label>Proveedor</label>
            <input type="text" id="inputProv" placeholder="Clic para buscar..." autocomplete="off">
            <div id="listaProv" class="lista-resultados"></div>
        </div>
        <div class="col" style="flex: 1;"><label>&nbsp;</label><button class="btn-plus" onclick="window.abrirModal('modalProv')">+</button></div>
    </div>

    <div class="row">
        <div class="col" style="flex: 10;">
            <label>Producto</label>
            <input type="text" id="inputProd" placeholder="Buscar..." autocomplete="off">
            <div id="listaProd" class="lista-resultados"></div>
        </div>
        <div class="col" style="flex: 1;"><label>&nbsp;</label><button class="btn-plus" onclick="window.abrirModal('modalProd')">+</button></div>
    </div>

    <div class="row">
        <div class="col"><label>Cant.</label><input type="number" id="cant" placeholder="1" value="1"></div>
        <div class="col"><label>Costo Unit.</label><input type="number" id="costo" placeholder="$"></div>
        <div class="col"><label>Lote / Ref</label><input type="text" id="lote" placeholder="Lote123"></div>
        <div class="col"><label>Vence</label><input type="date" id="vence"></div>
        <div class="col"><label>&nbsp;</label><button class="btn-add" id="btnAddItem">‚¨á A√ëADIR</button></div>
    </div>

    <table>
        <thead><tr><th>Producto</th><th>Cant.</th><th>Costo</th><th>Lote / Vence</th><th>Acci√≥n</th></tr></thead>
        <tbody id="tablaItems"></tbody>
    </table>

    <div style="text-align:right; font-size:1.3rem; font-weight:bold; margin-top:10px; color:#2c3e50;" id="txtTotalCompra">Total: $0</div>

    <div style="background: #eaf2f8; padding: 15px; border-radius: 8px; margin-top: 20px;">
        <label>M√©todo de Pago:</label>
        <select id="metodoPago" style="border: 2px solid #3498db;">
            <option value="Efectivo">üíµ Efectivo (Contado)</option>
            <option value="Bancos">üè¶ Bancos (Contado)</option>
            <option value="Credito">üìù Cr√©dito (Cuenta por Pagar)</option>
        </select>
        <button class="btn-save" id="btnGuardarTodo">‚úÖ GUARDAR ENTRADA</button>
    </div>

    <div class="historial-section">
        <h3>üìú Historial Completo de Compras & Deudas</h3>
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Proveedor</th>
                    <th>M√©todo</th>
                    <th>Total Factura</th>
                    <th>Abonado</th>
                    <th>Saldo Pendiente</th>
                </tr>
            </thead>
            <tbody id="listaHistorial">
                <tr><td colspan="6" style="text-align:center;">Cargando historial...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="modalProv" class="modal"><div class="modal-content">
    <h3>üë§ Nuevo Proveedor</h3>
    <label>Nombre Completo</label>
    <input type="text" id="newProvName" placeholder="Nombre">
    <label style="margin-top:10px;">NIT / Documento</label>
    <input type="text" id="newProvDoc" placeholder="Documento">
    <label style="margin-top:10px;">Tel√©fono</label>
    <input type="text" id="newProvTel" placeholder="Tel√©fono">
    <button class="save-modal" id="btnSaveProv">Guardar</button>
    <button class="close-modal" onclick="window.cerrarModal('modalProv')">Cancelar</button>
</div></div>

<div id="modalProd" class="modal"><div class="modal-content">
    <h3>üçé Nuevo Producto</h3>
    
    <label>Nombre del Producto</label>
    <input type="text" id="newProdName" placeholder="Ej: Manzanas">
    
    <label style="margin-top:10px;">Precio de Venta (P√∫blico)</label>
    <input type="number" id="newProdPrice" placeholder="$ 0">
    
    <button class="save-modal" id="btnSaveProd">Guardar Producto</button>
    <button class="close-modal" onclick="window.cerrarModal('modalProd')">Cancelar</button>
</div></div>

<script type="module">
    import { db, ref, push, onValue } from './firebase.js';

    window.abrirModal = (id) => document.getElementById(id).style.display = 'block';
    window.cerrarModal = (id) => document.getElementById(id).style.display = 'none';

    const nit = localStorage.getItem('userNit');
    if (!nit) window.location.href = "index.html";

    let listaIngreso = [];
    let todosClientes = [];
    let todosProductos = [];

    // CARGA DE DATOS
    onValue(ref(db, `companies/${nit}/clientes`), s => { todosClientes=[]; if(s.exists()) Object.values(s.val()).forEach(c=>todosClientes.push(c)); });
    onValue(ref(db, `companies/${nit}/productos`), s => { todosProductos=[]; if(s.exists()) Object.values(s.val()).forEach(p=>todosProductos.push(p)); });

    // BUSCADORES
    const inpProv = document.getElementById('inputProv');
    const mostrarProv = (txt="") => {
        const div=document.getElementById('listaProv'); div.innerHTML='';
        let res = txt===""?todosClientes.slice(0,10):todosClientes.filter(c=>c.nombre.toLowerCase().includes(txt.toLowerCase()));
        if(!res.length){div.style.display='none';return;}
        res.forEach(c=>{
            const d=document.createElement('div'); d.className='item-resultado'; d.innerText=c.nombre;
            d.onclick=()=>{inpProv.value=c.nombre; div.style.display='none';}; div.appendChild(d);
        }); div.style.display='block';
    };
    inpProv.addEventListener('input',(e)=>mostrarProv(e.target.value)); inpProv.addEventListener('focus',()=>mostrarProv(inpProv.value));

    const inpProd = document.getElementById('inputProd');
    const mostrarProd = (txt="") => {
        const div=document.getElementById('listaProd'); div.innerHTML='';
        let res = txt===""?todosProductos.slice(0,10):todosProductos.filter(p=>p.nombre.toLowerCase().includes(txt.toLowerCase()));
        if(!res.length){div.style.display='none';return;}
        res.forEach(p=>{
            const d=document.createElement('div'); d.className='item-resultado'; d.innerText=p.nombre;
            d.onclick=()=>{inpProd.value=p.nombre; div.style.display='none'; document.getElementById('cant').focus();}; div.appendChild(d);
        }); div.style.display='block';
    };
    inpProd.addEventListener('input',(e)=>mostrarProd(e.target.value)); inpProd.addEventListener('focus',()=>mostrarProd(inpProd.value));

    document.addEventListener('click', (e)=>{if(!e.target.matches('input')){document.getElementById('listaProv').style.display='none'; document.getElementById('listaProd').style.display='none';}});

    // AGREGAR AL CARRITO Y LIMPIAR
    document.getElementById('btnAddItem').onclick = () => {
        const producto = inpProd.value;
        const cantidad = parseInt(document.getElementById('cant').value);
        const costo = parseFloat(document.getElementById('costo').value);
        const lote = document.getElementById('lote').value || "S/L";
        const vence = document.getElementById('vence').value || "N/A";

        if(!producto || !cantidad || isNaN(costo)) return alert("Faltan datos");
        
        listaIngreso.push({ producto, cantidad, costo, subtotal: cantidad*costo, lote, vence });
        renderTabla();
        
        // Limpiar campos
        inpProd.value=""; 
        document.getElementById('costo').value="";
        document.getElementById('lote').value="";
        document.getElementById('vence').value="";
        document.getElementById('cant').value="1";
        inpProd.focus();
    };

    function renderTabla() {
        const tbody = document.getElementById('tablaItems'); tbody.innerHTML = "";
        let total = 0;
        listaIngreso.forEach((item, i) => {
            total += item.subtotal;
            tbody.innerHTML += `<tr><td>${item.producto}</td><td>${item.cantidad}</td><td>$${item.costo}</td><td><small>${item.lote}</small></td><td><button class="btn-danger" onclick="eliminarItem(${i})">X</button></td></tr>`;
        });
        document.getElementById('txtTotalCompra').innerText = `Total: $${total.toLocaleString()}`;
        window.eliminarItem = (i) => { listaIngreso.splice(i,1); renderTabla(); };
    }

    // GUARDAR COMPRA
    document.getElementById('btnGuardarTodo').onclick = async () => {
        const proveedor = inpProv.value;
        const metodo = document.getElementById('metodoPago').value;
        if(!listaIngreso.length || !proveedor) return alert("Faltan datos");

        const totalCompra = listaIngreso.reduce((acc, item) => acc + item.subtotal, 0);

        // Deuda
        let saldoInicial = metodo === 'Credito' ? totalCompra : 0;
        let abonadoInicial = metodo === 'Credito' ? 0 : totalCompra;

        try {
            await push(ref(db, `companies/${nit}/compras_registros`), {
                proveedor, total: totalCompra, metodo_pago: metodo, fecha: Date.now(), items: listaIngreso,
                saldo: saldoInicial, abonado: abonadoInicial
            });

            for (let item of listaIngreso) {
                await push(ref(db, `companies/${nit}/inventario`), {
                    ...item, proveedor, fecha_ingreso: Date.now(), tipo: "COMPRA"
                });
            }

            alert("‚úÖ Entrada Registrada");
            location.reload();
        } catch(e) { alert("Error: "+e.message); }
    };

    // HISTORIAL COMPLETO
    onValue(ref(db, `companies/${nit}/compras_registros`), s => {
        const tbody = document.getElementById('listaHistorial'); 
        tbody.innerHTML = "";
        
        if(!s.exists()) {
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>No hay historial de compras.</td></tr>";
            return;
        }

        let l = []; 
        s.forEach(c => l.push(c.val()));
        l.sort((a,b)=>b.fecha-a.fecha); // Ordenar reciente
        
        l.forEach(c => {
            const fecha = c.fecha ? new Date(c.fecha).toLocaleDateString() : 'S/F';
            const colorMetodo = c.metodo_pago==='Credito'?'red':'green';
            const saldo = c.saldo || 0;
            const abonado = c.abonado || 0;
            const colorSaldo = saldo > 0 ? 'color:red; font-weight:bold;' : 'color:green;';

            tbody.innerHTML += `
                <tr>
                    <td><small>${fecha}</small></td>
                    <td><strong>${c.proveedor}</strong></td>
                    <td><span class="badge" style="background:${colorMetodo}">${c.metodo_pago}</span></td>
                    <td><strong>$${c.total.toLocaleString()}</strong></td>
                    <td style="color:blue;">$${abonado.toLocaleString()}</td>
                    <td style="${colorSaldo}">$${saldo.toLocaleString()}</td>
                </tr>`;
        });
    });

    // GUARDAR RAPIDO PROVEEDOR
    document.getElementById('btnSaveProv').onclick = async () => {
        const nombre = document.getElementById('newProvName').value;
        if(nombre) { 
            await push(ref(db, `companies/${nit}/clientes`), { nombre, documento: document.getElementById('newProvDoc').value, telefono: document.getElementById('newProvTel').value }); 
            alert("Proveedor Creado"); 
            document.getElementById('inputProv').value = nombre;
            window.cerrarModal('modalProv'); 
        }
    };

    // GUARDAR RAPIDO PRODUCTO (CORREGIDO: NOMBRE Y PRECIO)
    document.getElementById('btnSaveProd').onclick = async () => {
        const nombre = document.getElementById('newProdName').value;
        const precio = parseFloat(document.getElementById('newProdPrice').value) || 0;
        
        if(nombre) { 
            await push(ref(db, `companies/${nit}/productos`), { 
                nombre: nombre, 
                precio: precio 
            }); 
            alert("Producto Creado"); 
            document.getElementById('inputProd').value = nombre;
            window.cerrarModal('modalProd'); 
        } else {
            alert("El nombre es obligatorio");
        }
    };
</script>
</body>
</html>
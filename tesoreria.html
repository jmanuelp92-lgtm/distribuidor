<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesorer√≠a - Distribuci√≥n Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 100%; max-width: 950px; }
        h2 { color: #c0392b; border-bottom: 3px solid #e74c3c; padding-bottom: 15px; margin-top: 0; }
        
        .search-section { position: relative; margin-bottom: 25px; }
        label { font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; background: #fafafa; }
        .btn-trash { background: #e74c3c; color: white; border: none; padding: 5px 10px; font-size: 1.1rem; border-radius: 4px; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid #eee; }
        th { background: #fadbd8; text-align: left; padding: 10px; color: #922b21; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        /* ... Estilos adicionales (botones, switch, etc) ... */
        .switch-container { display: flex; gap: 20px; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .btn-save { background: #e74c3c; color: white; width: 100%; padding: 15px; border: none; border-radius: 6px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top:20px;}
        .btn-back { background: #95a5a6; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 20px; }
        #seccionFacturas, #seccionOtro { display: none; }
        .row-selected { background-color: #f5b7b1; border-left: 5px solid #c0392b; }
        .total-box { text-align: right; font-size: 1.3rem; font-weight: bold; margin: 20px 0; color: #c0392b; }
        .lista-resultados { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
        .item-resultado { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .badge { padding: 3px 8px; border-radius: 12px; color: white; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-back" onclick="location.href='menu.html'">‚¨Ö Volver</button>
    <h2>üí∏ Tesorer√≠a (Pagos)</h2>

    <div class="search-section">
        <label>Buscar Proveedor / Beneficiario</label>
        <input type="text" id="inputProv" placeholder="Buscar..." autocomplete="off">
        <div id="listaProv" class="lista-resultados"></div>
    </div>

    <div class="switch-container">
        <label><input type="radio" name="tipoEgreso" value="factura" checked onchange="window.cambiarModo()"> Pago Factura (CXP)</label>
        <label><input type="radio" name="tipoEgreso" value="otro" onchange="window.cambiarModo()"> Gasto General</label>
    </div>

    <div id="seccionFacturas">
        <p style="color:#777;">Seleccione la factura de compra a pagar:</p>
        <table>
            <thead><tr><th>Sel</th><th>Fecha</th><th>Total</th><th>Abonado</th><th>Saldo</th><th>Pagar</th></tr></thead>
            <tbody id="listaFacturas"><tr><td colspan="6" style="text-align:center;">Busque un proveedor.</td></tr></tbody>
        </table>
    </div>

    <div id="seccionOtro">
        <label>Concepto</label><input type="text" id="descOtro" placeholder="Ej: Luz, Arriendo">
        <label>Valor</label><input type="number" id="valorOtro" placeholder="$ 0">
    </div>

    <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-top:20px;">
        <label>Origen del dinero</label>
        <select id="medioPago"><option>Caja General</option><option>Bancos</option></select>
        <label>Observaciones</label><textarea id="observaciones"></textarea>
    </div>

    <div class="total-box" id="txtTotalEgreso">Total: $0</div>
    <button class="btn-save" id="btnGuardar">üî¥ REGISTRAR EGRESO</button>

    <div style="margin-top:50px; border-top:2px dashed #ccc; padding-top:20px;">
        <h3>üìú Historial de Egresos</h3>
        <table>
            <thead><tr><th>Fecha</th><th>Beneficiario</th><th>Concepto</th><th>Valor</th><th>Tipo</th><th>Acci√≥n</th></tr></thead>
            <tbody id="tablaHistorialEgresos"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { db, ref, push, onValue, update, remove, get } from './firebase.js';

    const nit = localStorage.getItem('userNit');
    if (!nit) window.location.href = "index.html";

    let todosProveedores = [];
    let todosEgresos = [];
    let facturaSeleccionada = null; 

    // CARGA DE DATOS
    onValue(ref(db, `companies/${nit}/clientes`), s => { todosProveedores=[]; if(s.exists()) Object.values(s.val()).forEach(c=>todosProveedores.push(c)); });
    
    onValue(ref(db, `companies/${nit}/egresos`), (snap) => {
        todosEgresos = [];
        if (snap.exists()) { snap.forEach(c => { let v=c.val(); v.idFirebase=c.key; todosEgresos.push(v); }); }
        actualizarTablaHistorial(); 
    });

    // FUNCIONES PRINCIPALES
    function actualizarTablaHistorial() {
        const tbody = document.getElementById('tablaHistorialEgresos'); tbody.innerHTML = "";
        todosEgresos.sort((a,b) => b.fecha - a.fecha);
        
        todosEgresos.slice(0, 30).forEach(r => {
            tbody.innerHTML += `
                <tr>
                    <td>${new Date(r.fecha).toLocaleDateString()}</td>
                    <td><strong>${r.beneficiario}</strong></td>
                    <td>${r.concepto}</td>
                    <td style="color:#c0392b; font-weight:bold;">$${parseFloat(r.valor).toLocaleString()}</td>
                    <td>${r.tipo === 'EGRESO_CXP' ? 'Pago CXP' : 'Gasto'}</td>
                    <td><button class="btn-trash" onclick="eliminarEgreso('${r.idFirebase}')">üóëÔ∏è</button></td>
                </tr>`;
        });
    }

    // --- FUNCI√ìN CR√çTICA: ELIMINAR EGRESO (RESTAURA DEUDA) ---
    window.eliminarEgreso = async (idEgreso) => {
        if(!confirm("‚ö†Ô∏è ¬øEliminar este pago? \n\nSi era pago de factura, la deuda volver√° a subir.")) return;

        try {
            const snap = await get(ref(db, `companies/${nit}/egresos/${idEgreso}`));
            if (!snap.exists()) return;
            const egreso = snap.val();

            // Si es pago de factura, devolvemos la deuda
            if (egreso.tipo === 'EGRESO_CXP' && egreso.id_compra) {
                const compraRef = ref(db, `companies/${nit}/compras_registros/${egreso.id_compra}`);
                const compraSnap = await get(compraRef);
                if (compraSnap.exists()) {
                    const compra = compraSnap.val();
                    await update(compraRef, {
                        saldo: (compra.saldo || 0) + parseFloat(egreso.valor),
                        abonado: (compra.abonado || 0) - parseFloat(egreso.valor)
                    });
                }
            }
            await remove(ref(db, `companies/${nit}/egresos/${idEgreso}`));
            alert("‚úÖ Egreso eliminado y cuentas ajustadas.");
        } catch(e) { alert("Error: " + e.message); }
    };

    // L√ìGICA DE INTERFAZ (Igual que antes)
    const inpProv = document.getElementById('inputProv');
    const mostrarProv = (txt="") => {
        const div = document.getElementById('listaProv'); div.innerHTML='';
        let res = txt==="" ? todosProveedores.slice(0,10) : todosProveedores.filter(c=>c.nombre.toLowerCase().includes(txt.toLowerCase()));
        if(!res.length){ div.style.display='none'; return;}
        res.forEach(c=>{const d=document.createElement('div'); d.className='item-resultado'; d.innerText=c.nombre; d.onclick=()=>{inpProv.value=c.nombre; div.style.display='none'; cargarDeudas(c.nombre);}; div.appendChild(d);}); div.style.display='block';
    };
    inpProv.addEventListener('input', (e)=>mostrarProv(e.target.value)); inpProv.addEventListener('focus', ()=>mostrarProv(inpProv.value));
    
    function cargarDeudas(nombre) {
        const tbody = document.getElementById('listaFacturas'); tbody.innerHTML = "";
        onValue(ref(db, `companies/${nit}/compras_registros`), (snap) => {
            tbody.innerHTML = "";
            if (snap.exists()) {
                snap.forEach(c => {
                    const compra = c.val();
                    if (compra.proveedor === nombre && compra.saldo > 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td><input type="radio" name="sf" onclick="selFactura('${c.key}', ${compra.saldo})"></td><td>${new Date(compra.fecha).toLocaleDateString()}</td><td>$${compra.total.toLocaleString()}</td><td>$${(compra.abonado||0).toLocaleString()}</td><td>$${compra.saldo.toLocaleString()}</td><td><input id="abono_${c.key}" disabled type="number" style="width:100px;"></td>`;
                        tr.querySelector(`#abono_${c.key}`).oninput=(e)=>{document.getElementById('txtTotalEgreso').innerText=`$${e.target.value}`;};
                        tbody.appendChild(tr);
                    }
                });
            }
        }, {onlyOnce: true});
    }

    window.selFactura = (key, saldo) => {
        document.querySelectorAll('input[type=number]').forEach(i=>{i.disabled=true;i.value=''});
        const inp = document.getElementById(`abono_${key}`);
        inp.disabled=false; inp.value=saldo; inp.focus();
        facturaSeleccionada = {id: key, saldo: saldo};
        document.getElementById('txtTotalEgreso').innerText=`$${saldo}`;
    };

    window.cambiarModo = () => {
        const m = document.querySelector('input[name="tipoEgreso"]:checked').value;
        document.getElementById('seccionFacturas').style.display = m==='factura'?'block':'none';
        document.getElementById('seccionOtro').style.display = m==='otro'?'block':'none';
    };
    cambiarModo();

    document.getElementById('btnGuardar').onclick = async () => {
        const modo = document.querySelector('input[name="tipoEgreso"]:checked').value;
        const prov = document.getElementById('inputProv').value;
        if(modo==='factura' && !facturaSeleccionada) return alert("Seleccione factura");
        
        try {
            if(modo==='factura') {
                const val = parseFloat(document.getElementById(`abono_${facturaSeleccionada.id}`).value);
                await push(ref(db, `companies/${nit}/egresos`), { fecha: Date.now(), beneficiario: prov, concepto: "Pago Factura", valor: val, tipo: "EGRESO_CXP", id_compra: facturaSeleccionada.id });
                
                // Actualizar Deuda Compra
                const compraRef = ref(db, `companies/${nit}/compras_registros/${facturaSeleccionada.id}`);
                const snap = await get(compraRef);
                const c = snap.val();
                await update(compraRef, { saldo: c.saldo - val, abonado: (c.abonado||0) + val });
            } else {
                const val = parseFloat(document.getElementById('valorOtro').value);
                await push(ref(db, `companies/${nit}/egresos`), { fecha: Date.now(), beneficiario: prov||"Varios", concepto: document.getElementById('descOtro').value, valor: val, tipo: "EGRESO_GASTO" });
            }
            alert("Egreso guardado"); location.reload();
        } catch(e) { alert(e.message); }
    };
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventas - Distribuci√≥n Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 100%; max-width: 1100px; }
        h2 { color: #e67e22; border-bottom: 3px solid #d35400; padding-bottom: 15px; margin-top: 0; }
        
        label { font-weight: bold; font-size: 0.9rem; color: #555; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; transition: 0.3s; background: #fafafa; }
        input:focus { border-color: #e67e22; outline: none; background: white; }

        .row { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
        .col { flex: 1; position: relative; }
        .col-btn { width: 60px; flex: none; }

        .lista-resultados { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; }
        .item-resultado { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .item-resultado:hover { background: #fdf2e9; color: #d35400; }

        button { cursor: pointer; font-weight: bold; border: none; border-radius: 6px; transition: 0.3s; }
        .btn-back { background: #95a5a6; color: white; padding: 8px 15px; margin-bottom: 20px; }
        .btn-plus { background: #27ae60; color: white; width: 100%; height: 46px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; }
        .btn-add { background: #2980b9; color: white; padding: 12px; height: 100%; width: 100%; }
        .btn-final { background: #27ae60; color: white; padding: 15px; width: 100%; font-size: 1.5rem; margin-top: 20px; }
        .btn-danger { background: #c0392b; color: white; padding: 5px 10px; font-size: 0.9rem; }
        .btn-eye { background: #f39c12; color: white; padding: 5px 10px; font-size: 1.1rem; border-radius: 4px; margin-right: 5px; }
        .btn-trash { background: #e74c3c; color: white; padding: 5px 10px; font-size: 1.1rem; border-radius: 4px; }
        .btn-entregar { background: #3498db; color: white; padding: 5px 10px; font-size: 0.85rem; border-radius: 4px; }

        #selectorLotes { display: none; background: #eaf2f8; padding: 15px; border: 1px solid #3498db; border-radius: 6px; margin-bottom: 15px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; overflow-y: auto; }
        .modal-content { background: white; width: 500px; margin: 5% auto; padding: 25px; border-radius: 12px; position: relative; }
        .close-modal { background: #e74c3c; color: white; width: 100%; padding: 10px; margin-top: 10px; }
        .save-modal { background: #2980b9; color: white; width: 100%; padding: 10px; margin-top: 15px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #eee; }
        th { background: #fdf2e9; text-align: left; padding: 12px; color: #d35400; font-size: 0.9rem; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.85rem; vertical-align: middle; }
        
        .historial-section { margin-top: 50px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.75rem; display: inline-block; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-back" onclick="location.href='menu.html'">‚¨Ö Volver</button>
    <h2>üöö Nueva Venta</h2>

    <div class="row">
        <div class="col" style="flex: 2;">
            <label>Cliente</label>
            <input type="text" id="inputCliente" placeholder="Buscar..." autocomplete="off">
            <div id="listaCliente" class="lista-resultados"></div>
        </div>
        <div class="col-btn">
            <label>&nbsp;</label>
            <button class="btn-plus" onclick="window.abrirModal('modalCliente')">+</button>
        </div>
        <div class="col" style="flex: 1;">
            <label>Fecha Venta</label>
            <input type="date" id="fechaVenta">
        </div>
    </div>

    <div class="row">
        <div class="col" style="flex: 1;">
            <label>Producto</label>
            <input type="text" id="inputProd" placeholder="Buscar..." autocomplete="off">
            <div id="listaProd" class="lista-resultados"></div>
        </div>
        <div class="col-btn">
            <label>&nbsp;</label>
            <button class="btn-plus" onclick="window.abrirModal('modalProd')">+</button>
        </div>
    </div>

    <div id="selectorLotes">
        <label style="color:#2980b9;">üìÖ Selecciona el Lote (Stock disponible):</label>
        <select id="selLoteEspecifico"><option value="">-- Cargando lotes --</option></select>
    </div>

    <div class="row">
        <div class="col"><label>Cant.</label><input type="number" id="cant" placeholder="1" value="1"></div>
        <div class="col"><label>Precio Unit.</label><input type="number" id="precio" placeholder="$ Auto"></div>
        <div class="col"><label>&nbsp;</label><button class="btn-add" id="btnAddItem">‚¨á A√ëADIR</button></div>
    </div>

    <table style="border: 2px solid #e67e22;">
        <thead style="background:#fff3e0;"><tr><th>Producto / Lote</th><th>Cant.</th><th>P. Unit.</th><th>Subtotal</th><th>X</th></tr></thead>
        <tbody id="tablaVentas"></tbody>
    </table>
    <div style="text-align:right; font-size:1.3rem; font-weight:bold; margin-top:10px; color:#d35400;" id="txtTotal">Total: $0</div>

    <div style="background: #fdf2e9; padding: 15px; margin-top: 20px; border-radius: 8px;">
        <label>M√©todo de Pago:</label>
        <select id="metodoPago">
            <option value="Efectivo">Efectivo</option>
            <option value="Bancos">Bancos</option>
            <option value="Credito">Credito</option>
        </select>
        <button class="btn-final" id="btnFinalizar">üí∞ CONFIRMAR VENTA</button>
    </div>

    <div class="historial-section">
        <h3>üìú Historial de Ventas</h3>
        <table>
            <thead>
                <tr><th>Fecha</th><th>Cliente</th><th>Total</th><th>Pago</th><th>Estado</th><th>Acciones</th></tr>
            </thead>
            <tbody id="listaHistorial"><tr><td colspan="6" style="text-align:center;">Cargando...</td></tr></tbody>
        </table>
    </div>
</div>

<div id="modalCliente" class="modal">
    <div class="modal-content">
        <h3 style="color:#e67e22;">üë§ Nuevo Cliente / Tercero</h3>
        <label>Nombre Completo</label>
        <input type="text" id="ncNombre" placeholder="Nombre">
        
        <label>Documento / NIT</label>
        <input type="text" id="ncDoc" placeholder="Documento">
        
        <label>Tel√©fono</label>
        <input type="text" id="ncTel" placeholder="Tel√©fono">
        
        <label>Finca / Ubicaci√≥n</label>
        <input type="text" id="ncFinca" placeholder="Direcci√≥n o Finca">
        
        <button class="save-modal" id="btnSaveCliente">Guardar Cliente</button>
        <button class="close-modal" onclick="window.cerrarModal('modalCliente')">Cancelar</button>
    </div>
</div>

<div id="modalProd" class="modal">
    <div class="modal-content">
        <h3 style="color:#e67e22;">üçé Nuevo Producto</h3>
        <label>Nombre del Producto</label>
        <input type="text" id="npNombre" placeholder="Ej: Manzanas">
        
        <label>Precio de Venta Sugerido</label>
        <input type="number" id="npPrecio" placeholder="$ 0">
        
        <button class="save-modal" id="btnSaveProd">Guardar Producto</button>
        <button class="close-modal" onclick="window.cerrarModal('modalProd')">Cancelar</button>
    </div>
</div>

<div id="modalDetalle" class="modal"><div class="modal-content">
    <h3 style="color:#d35400;">üìã Detalle de Venta</h3>
    <p><strong>Cliente:</strong> <span id="lblClienteDetalle"></span></p>
    <table style="width:100%;"><thead><tr><th>Producto</th><th>Cant.</th><th>P. Unit.</th><th>Subtotal</th></tr></thead><tbody id="tablaDetalleItems"></tbody></table>
    <h3 style="text-align:right; margin-top:10px;" id="lblTotalDetalle"></h3>
    <button class="close-modal" onclick="window.cerrarModal('modalDetalle')">Cerrar</button>
</div></div>

<script type="module">
    import { db, ref, push, onValue, update, remove, get } from './firebase.js';

    window.abrirModal = (id) => document.getElementById(id).style.display = 'block';
    window.cerrarModal = (id) => document.getElementById(id).style.display = 'none';

    document.getElementById('fechaVenta').valueAsDate = new Date();

    const nit = localStorage.getItem('userNit');
    if (!nit) window.location.href = "index.html";

    let carrito = [];
    let todosClientes = [];
    let todosProductos = [];
    let inventarioCompleto = [];
    let ventasCache = [];

    // CARGA DATOS
    onValue(ref(db, `companies/${nit}/clientes`), s => { todosClientes=[]; if(s.exists()) Object.values(s.val()).forEach(c=>todosClientes.push(c)); });
    onValue(ref(db, `companies/${nit}/productos`), s => { todosProductos=[]; if(s.exists()) Object.values(s.val()).forEach(p=>todosProductos.push(p)); });
    onValue(ref(db, `companies/${nit}/inventario`), s => { 
        inventarioCompleto=[]; if(s.exists()) { s.forEach(c => { let i=c.val(); i.idFirebase=c.key; inventarioCompleto.push(i); }); }
    });

    // BUSCADORES
    const inpCli = document.getElementById('inputCliente');
    const mostrarCli = (txt="") => {
        const div = document.getElementById('listaCliente'); div.innerHTML='';
        let res = txt==="" ? todosClientes.slice(0,10) : todosClientes.filter(c=>c.nombre.toLowerCase().includes(txt.toLowerCase()));
        if(!res.length){ div.style.display='none'; return;}
        res.forEach(c=>{
            const d=document.createElement('div'); d.className='item-resultado'; d.innerText=c.nombre;
            d.onclick=()=>{inpCli.value=c.nombre; div.style.display='none';}; div.appendChild(d);
        }); div.style.display='block';
    };
    inpCli.addEventListener('input', (e)=>mostrarCli(e.target.value)); inpCli.addEventListener('focus', ()=>mostrarCli(inpCli.value));

    const inpProd = document.getElementById('inputProd');
    const mostrarProd = (txt="") => {
        const div = document.getElementById('listaProd'); div.innerHTML='';
        let res = txt==="" ? todosProductos.slice(0,10) : todosProductos.filter(p=>p.nombre.toLowerCase().includes(txt.toLowerCase()));
        if(!res.length){ div.style.display='none'; return;}
        res.forEach(p=>{
            const d=document.createElement('div'); d.className='item-resultado'; 
            d.innerHTML=`${p.nombre} <span style="float:right;color:#e67e22">$${p.precio}</span>`;
            d.onclick=()=>{
                inpProd.value=p.nombre; document.getElementById('precio').value=p.precio; div.style.display='none';
                buscarLotesDisponibles(p.nombre); 
            }; 
            div.appendChild(d);
        }); div.style.display='block';
    };
    inpProd.addEventListener('input', (e)=>mostrarProd(e.target.value)); inpProd.addEventListener('focus', ()=>mostrarProd(inpProd.value));
    document.addEventListener('click', (e)=>{if(!e.target.matches('input')){document.getElementById('listaCliente').style.display='none'; document.getElementById('listaProd').style.display='none';}});

    function buscarLotesDisponibles(nombreProducto) {
        const selectorDiv = document.getElementById('selectorLotes');
        const select = document.getElementById('selLoteEspecifico');
        select.innerHTML = '<option value="">-- Seleccione Lote --</option>';
        const lotes = inventarioCompleto.filter(item => item.producto === nombreProducto && item.tipo === 'COMPRA' && parseInt(item.cantidad) > 0);
        if(lotes.length > 0) {
            selectorDiv.style.display = 'block';
            lotes.sort((a,b) => (a.vence > b.vence) ? 1 : -1);
            lotes.forEach(lote => {
                const option = document.createElement('option');
                option.value = lote.idFirebase; 
                option.text = `${lote.lote} - ${lote.vence || ''} (Disp: ${lote.cantidad})`;
                option.setAttribute('data-max', lote.cantidad); 
                option.setAttribute('data-detalle', `${lote.lote} ${lote.vence || ''}`);
                select.appendChild(option);
            });
        } else { selectorDiv.style.display = 'none'; alert("‚ö†Ô∏è No hay stock disponible."); }
    }

    // AGREGAR ITEM
    document.getElementById('btnAddItem').onclick = () => {
        const producto = inpProd.value;
        const cantidad = parseInt(document.getElementById('cant').value);
        const precio = parseFloat(document.getElementById('precio').value);
        const select = document.getElementById('selLoteEspecifico');
        
        if(!producto || !cantidad || !precio) return alert("Faltan datos");
        if(select.style.display !== 'none' && !select.value) return alert("Seleccione un lote.");

        if(select.value) {
            const idLote = select.value;
            const stockMax = parseInt(select.options[select.selectedIndex].getAttribute('data-max'));
            const textoDetalle = select.options[select.selectedIndex].getAttribute('data-detalle');

            let cantidadEnCarrito = 0;
            carrito.forEach(item => { if(item.idLote === idLote) cantidadEnCarrito += item.cantidad; });

            if ((cantidad + cantidadEnCarrito) > stockMax) return alert(`‚ö†Ô∏è STOCK INSUFICIENTE\nDisponible: ${stockMax}\nEn carrito: ${cantidadEnCarrito}`);

            carrito.push({ producto, cantidad, precio, subtotal: cantidad*precio, idLote: idLote, loteDetalle: textoDetalle, stockActual: stockMax });
        } else {
            carrito.push({ producto, cantidad, precio, subtotal: cantidad*precio, idLote: null, loteDetalle: "S/L" });
        }
        
        renderCarrito();
        inpProd.value=""; document.getElementById('precio').value=""; document.getElementById('cant').value="1";
        document.getElementById('selectorLotes').style.display = 'none'; inpProd.focus();
    };

    function renderCarrito() {
        const tbody = document.getElementById('tablaVentas'); tbody.innerHTML = "";
        let total = 0;
        carrito.forEach((item, i) => {
            total += item.subtotal;
            tbody.innerHTML += `<tr><td><strong>${item.producto}</strong><br><small style="color:blue">${item.loteDetalle}</small></td><td>${item.cantidad}</td><td>$${item.precio.toLocaleString()}</td><td>$${item.subtotal.toLocaleString()}</td><td><button class="btn-danger" onclick="eliminarItem(${i})">X</button></td></tr>`;
        });
        document.getElementById('txtTotal').innerText = `Total: $${total.toLocaleString()}`;
        window.eliminarItem = (i) => { carrito.splice(i,1); renderCarrito(); };
    }

    document.getElementById('btnFinalizar').onclick = async () => {
        const cliente = document.getElementById('inputCliente').value;
        const metodo = document.getElementById('metodoPago').value;
        const fechaInput = document.getElementById('fechaVenta').value;

        if(!carrito.length || !cliente) return alert("Faltan datos");
        if(!fechaInput) return alert("Seleccione fecha.");
        
        const fechaTimestamp = new Date(fechaInput + "T12:00:00").getTime();
        const totalVenta = carrito.reduce((acc, item) => acc + item.subtotal, 0);
        let saldoInicial = metodo === 'Credito' ? totalVenta : 0;
        let abonadoInicial = metodo === 'Credito' ? 0 : totalVenta;

        try {
            await push(ref(db, `companies/${nit}/ventas`), {
                cliente, items: carrito, total: totalVenta, metodo_pago: metodo, fecha: fechaTimestamp, 
                tipo: "VENTA", saldo: saldoInicial, abonado: abonadoInicial, estado_entrega: "PENDIENTE"
            });
            const updates = {};
            carrito.forEach(item => { if (item.idLote) updates[`companies/${nit}/inventario/${item.idLote}/cantidad`] = item.stockActual - item.cantidad; });
            if (Object.keys(updates).length > 0) await update(ref(db), updates);
            alert("‚úÖ Venta Registrada"); location.reload();
        } catch(e) { alert("Error: " + e.message); }
    };

    const historialRef = ref(db, `companies/${nit}/ventas`);
    onValue(historialRef, (snapshot) => {
        const tbody = document.getElementById('listaHistorial'); tbody.innerHTML = ""; ventasCache = []; 
        if (!snapshot.exists()) { tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Sin ventas.</td></tr>"; return; }
        const ventas = [];
        snapshot.forEach((child) => { let v=child.val(); v.idFirebase=child.key; ventas.push(v); });
        ventas.sort((a, b) => b.fecha - a.fecha);
        ventasCache = ventas;
        ventas.slice(0, 50).forEach(v => {
            const btnEntrega = (v.estado_entrega === "ENTREGADO") ? '<span style="color:green;font-weight:bold;">‚úÖ OK</span>' : `<button class="btn-entregar" onclick="marcarEntregado('${v.idFirebase}')">üì¶ Pend.</button>`;
            tbody.innerHTML += `<tr><td>${new Date(v.fecha).toLocaleDateString()}</td><td>${v.cliente}</td><td>$${v.total.toLocaleString()}</td><td>${v.metodo_pago}</td><td>${btnEntrega}</td><td style="text-align:center;"><button class="btn-eye" onclick="verDetalle('${v.idFirebase}')">üëÅÔ∏è</button><button class="btn-trash" onclick="eliminarVenta('${v.idFirebase}')">üóëÔ∏è</button></td></tr>`;
        });
    });

    window.marcarEntregado = async (id) => { if(confirm("¬øMarcar entregado?")) await update(ref(db, `companies/${nit}/ventas/${id}`), { estado_entrega: "ENTREGADO" }); };

    window.eliminarVenta = async (idVenta) => {
        if(!confirm("‚ö†Ô∏è ¬øEliminar venta? Se devolver√° el stock.")) return;
        try {
            const snapshot = await get(ref(db, `companies/${nit}/ventas/${idVenta}`));
            if (!snapshot.exists()) return;
            const venta = snapshot.val();
            const updates = {};
            if (venta.items) {
                for (const item of venta.items) {
                    if (item.idLote) {
                        const stockSnap = await get(ref(db, `companies/${nit}/inventario/${item.idLote}/cantidad`));
                        let stockActual = 0; if (stockSnap.exists()) stockActual = parseInt(stockSnap.val());
                        updates[`companies/${nit}/inventario/${item.idLote}/cantidad`] = stockActual + parseInt(item.cantidad);
                    }
                }
            }
            if (Object.keys(updates).length > 0) await update(ref(db), updates);
            await remove(ref(db, `companies/${nit}/ventas/${idVenta}`));
            alert("‚úÖ Venta eliminada.");
        } catch (e) { alert("Error: " + e.message); }
    };

    window.verDetalle = (id) => {
        const v = ventasCache.find(x => x.idFirebase === id);
        if(!v) return;
        document.getElementById('lblClienteDetalle').innerText = v.cliente;
        document.getElementById('lblTotalDetalle').innerText = `$${v.total.toLocaleString()}`;
        const tb = document.getElementById('tablaDetalleItems'); tb.innerHTML="";
        if(v.items) {
            v.items.forEach(i => {
                const pUnit = i.precio ? i.precio : (i.subtotal / i.cantidad);
                tb.innerHTML += `<tr><td>${i.producto}</td><td>${i.cantidad}</td><td>$${pUnit.toLocaleString()}</td><td>$${i.subtotal.toLocaleString()}</td></tr>`;
            });
        }
        window.abrirModal('modalDetalle');
    };

    // --- LOGICA DE GUARDADO EN MODALES ---
    document.getElementById('btnSaveCliente').onclick = async () => {
        const nombre = document.getElementById('ncNombre').value;
        const documento = document.getElementById('ncDoc').value;
        const telefono = document.getElementById('ncTel').value;
        const finca = document.getElementById('ncFinca').value;

        if(!nombre || !documento) return alert("Nombre y Documento son obligatorios");

        try {
            await push(ref(db, `companies/${nit}/clientes`), { 
                nombre, documento, telefono, finca 
            });
            alert("‚úÖ Cliente Guardado");
            window.cerrarModal('modalCliente');
            // Auto-seleccionar
            document.getElementById('inputCliente').value = nombre;
        } catch(e) { alert("Error: " + e.message); }
    };

    document.getElementById('btnSaveProd').onclick = async () => {
        const nombre = document.getElementById('npNombre').value;
        const precio = document.getElementById('npPrecio').value;

        if(!nombre) return alert("El nombre es obligatorio");

        try {
            await push(ref(db, `companies/${nit}/productos`), { 
                nombre, precio: precio || 0 
            });
            alert("‚úÖ Producto Guardado");
            window.cerrarModal('modalProd');
            // Auto-seleccionar
            document.getElementById('inputProd').value = nombre;
            document.getElementById('precio').value = precio;
        } catch(e) { alert("Error: " + e.message); }
    };
</script>
</body>
</html>